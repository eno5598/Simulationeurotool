<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Lotto Suite (Eurojackpot + 6aus49) • Hybrid</title>

<!-- deps -->
<link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
  :root{ --cy:#00fff0; --mag:#ff00ea; --ink:#eaf7ff; --bg:#060712; --ok:#39ff88; --bad:#ff6b94; --amber:#f59e0b; }
  body{background:radial-gradient(900px 700px at -10% -10%, rgba(0,255,240,.12), transparent 60%), radial-gradient(900px 700px at 110% -10%, rgba(255,0,234,.12), transparent 60%), var(--bg); color:var(--ink); font-family:Inter, ui-sans-serif, system-ui;}
  .title{background:linear-gradient(90deg,var(--cy),var(--mag)); -webkit-background-clip:text; color:transparent; font-weight:900}
  .glass{background:rgba(15,18,40,.78); backdrop-filter: blur(14px); border:1px solid rgba(0,255,255,.18); border-radius:14px; padding:14px; box-shadow: 0 12px 40px rgba(0,0,0,.45);}
  .nav-btn{display:flex;flex-direction:column;align-items:center;justify-content:center;gap:6px; min-width:90px;height:78px;padding:8px 10px;border-radius:16px;background:linear-gradient(180deg,rgba(18,24,50,.9),rgba(14,18,36,.9)); border:1px solid rgba(255,255,255,.08); box-shadow: inset 0 0 0 1px rgba(255,255,255,.06), 0 8px 22px rgba(0,0,0,.4);}
  .nav-btn.active{outline:2px solid rgba(255,255,255,.15); box-shadow:0 0 20px rgba(0,255,255,.35), inset 0 0 0 1px rgba(255,255,255,.1);}
  .badge{background:rgba(255,255,255,.06); border:1px solid rgba(140,170,255,.22); border-radius:999px; padding:.15rem .6rem; font-size:.74rem;}
  .btn{display:inline-flex;align-items:center;justify-content:center;gap:.5rem;height:44px;padding:0 12px;border-radius:12px;border:1px solid rgba(255,255,255,.08);font-weight:700}
  .btn--green{background:#15803d;color:#fff;}
  .btn--amber{background:#b45309;color:#fff;}
  .btn--gray{background:#374151;color:#fff;}
  .btn:hover{filter:brightness(1.1)}
  .file-label{cursor:pointer; padding:10px 14px; border-radius:12px; border:1px solid rgba(255,255,255,.08); background:linear-gradient(180deg,rgba(18,24,50,.9),rgba(14,18,36,.9)); display:inline-flex; gap:8px; align-items:center;}
  .file-input{display:none}
  .chip{display:inline-flex;align-items:center;justify-content:center;min-width:32px;height:32px;border-radius:10px;margin:4px;font-weight:800;font-size:.9rem;color:#bdfcff;background:linear-gradient(180deg,#0e1530,#15204a);border:1px solid rgba(0,255,255,.25);}
  .chip.euro{color:#ffe6ff;background:linear-gradient(180deg,#1c1433,#1c2b53);border-color:rgba(255,0,234,.3)}
  .chip.sel{background:linear-gradient(180deg,rgba(0,255,240,.25),rgba(0,255,240,.05)); box-shadow:0 0 16px rgba(0,255,240,.35), inset 0 0 0 1px rgba(0,255,255,.45); }
  #drumBox{width:100%; aspect-ratio: 4/3; max-height:70vh;}
  #drumCanvas{width:100%; height:100%; background:#0b1022; border:1px solid rgba(255,255,255,.1); border-radius:.7rem; display:block}
  .map{display:grid; grid-template-columns: repeat(10, minmax(0,1fr)); gap:6px;}
  .cell{position:relative; text-align:center; border-radius:10px; padding:8px 0; font-weight:800; border:1px solid rgba(0,255,255,.15);
        background:linear-gradient(180deg,#0e1530,#15204a); color:#bdfcff;}
  .cell .cnt{position:absolute; right:6px; bottom:4px; font-size:.65rem; opacity:.8}
  .cell.sel{box-shadow:0 0 16px rgba(0,255,240,.5), inset 0 0 0 1px rgba(0,255,255,.6);}
</style>
</head>
<body class="p-5">
  <div class="flex items-center justify-between mb-3 flex-wrap gap-2">
    <h1 class="title text-3xl md:text-4xl">Lotto Suite</h1>
    <div class="flex items-center gap-2">
      <span class="badge">Spiel:</span>
      <select id="gameSelect" class="bg-gray-900 p-2 rounded">
        <option value="eurojackpot">Eurojackpot</option>
        <option value="lotto6aus49">6 aus 49 (Bayern)</option>
      </select>
    </div>
  </div>

  <div class="flex justify-center flex-wrap gap-3 mb-6">
    <button type="button" onclick="tab('archiv', this)" class="nav-btn active" id="btn-archiv"><div>📂</div><span>Archiv</span></button>
    <button type="button" onclick="tab('map', this)" class="nav-btn" id="btn-map"><div>🗺️</div><span>Map</span></button>
    <button type="button" onclick="tab('gen', this)" class="nav-btn" id="btn-gen"><div>⚡</div><span>Generieren</span></button>
    <button type="button" onclick="tab('trommel', this)" class="nav-btn" id="btn-trommel"><div>🎱</div><span>Trommel</span></button>
    <button type="button" onclick="tab('ana', this)" class="nav-btn" id="btn-ana"><div>📊</div><span>Analyse</span></button>
  </div>

  <!-- ARCHIV -->
  <div id="v-archiv" class="glass">
    <div class="flex items-center justify-between">
      <h2 class="text-xl font-bold mb-2">📂 Archiv</h2>
      <div class="badge" id="freshLabel">–</div>
    </div>
    <p id="statusText" class="text-sm mb-2">Noch kein Archiv geladen.</p>

    <div class="glass mb-3">
      <div class="font-semibold mb-2">Automatisches Laden</div>
      <div class="flex flex-col md:flex-row gap-2">
        <input id="archiveUrl" class="bg-gray-900 p-2 rounded flex-1">
        <button type="button" id="loadLatestBtn" class="btn btn--green">📥 Neueste laden</button>
        <button type="button" id="forceDlBtn" class="btn btn--amber">⬇️ ZIP speichern</button>
        <a id="directDl" class="btn btn--gray" target="_blank" rel="noopener">🔗 Direktlink</a>
      </div>
      <p class="text-xs text-gray-300 mt-2">ZIP/TXT/CSV werden über mehrere CORS‑Proxys versucht, ansonsten Link öffnen.</p>
    </div>

    <div class="glass mb-3">
      <div class="font-semibold mb-2">Manuell laden</div>
      <label class="file-label">
        📄 Datei auswählen
        <input type="file" id="zipInput" class="file-input" accept=".zip,.txt,.csv">
      </label>
      <span id="fileName" class="ml-2 text-sm opacity-80">Keine Datei ausgewählt</span>
    </div>

    <div class="grid grid-cols-2 md:grid-cols-4 gap-2 text-center">
      <div><div class="text-sm text-gray-300">Ziehungen</div><div id="kpiCount" class="font-bold">–</div></div>
      <div><div class="text-sm text-gray-300">Von</div><div id="kpiFrom" class="font-bold">–</div></div>
      <div><div class="text-sm text-gray-300">Bis</div><div id="kpiTo" class="font-bold">–</div></div>
      <div><div class="text-sm text-gray-300">Aktualität</div><div id="kpiFresh" class="font-bold">–</div></div>
    </div>
  </div>

  <!-- MAP -->
  <div id="v-map" class="glass hidden">
    <div class="flex items-center justify-between mb-1">
      <h2 class="text-xl font-bold">🗺 Map</h2>
      <div class="badge">Live‑Auswahl</div>
    </div>
    <div class="mb-1 flex items-center justify-between">
      <div class="badge" id="mapBadgeMain">Hauptzahlen</div><div id="progress" class="badge">Bereit</div>
    </div>
    <div id="mapMain" class="flex flex-wrap"></div>
    <div class="mt-3 badge" id="mapBadgeExtra">Extra</div>
    <div id="mapExtra" class="flex flex-wrap"></div>
  </div>

  <!-- GENERIEREN -->
  <div id="v-gen" class="glass hidden">
    <h2 class="text-xl font-bold mb-2">⚡ Generieren</h2>
    <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
      <div>
        <label class="text-sm text-gray-300">Modus</label>
        <select id="modus" class="bg-gray-900 p-2 rounded w-full">
          <option value="simple">Zufall (Archiv-gewichtet)</option>
          <option value="groups">Gruppen + Wünsche</option>
        </select>
      </div>
      <div>
        <label class="text-sm text-gray-300">Anzahl Kombinationen</label>
        <input type="number" id="kombis" value="5" min="1" max="25" class="bg-gray-900 p-2 rounded w-full">
      </div>
      <div class="grid grid-cols-3 gap-2">
        <button type="button" id="generateBtn" class="btn btn--green">⚡ Generieren</button>
        <button type="button" id="analyseAllBtn" class="btn btn--amber">📊 Alle analysieren</button>
        <button type="button" id="clearGeneratedBtn" class="btn btn--gray">🗑️ Alle löschen</button>
      </div>
    </div>

    <div id="groupUI" class="mt-4 hidden">
      <div class="mb-1 text-sm text-gray-300 flex items-center gap-3">
        <span id="groupHint">Gruppen</span>
        <span id="mainCounter" class="badge">0</span>
        <span id="extraCounter" class="badge">0</span>
      </div>
      <div id="groupControls" class="grid grid-cols-1 md:grid-cols-2 gap-2"></div>
      <div id="extraControls" class="grid grid-cols-2 gap-2 mt-2 hidden"></div>
      <div id="groupError" class="bg-red-900/40 border border-red-400 text-red-200 rounded px-2 py-1 hidden mt-2"></div>
    </div>

    <pre id="liveOutput" class="font-mono bg-black/70 p-3 mt-3 rounded h-44 overflow-auto text-green-300"></pre>
    <div id="cards" class="mt-3"></div>
  </div>

  <!-- TROMMEL -->
  <div id="v-trommel" class="glass hidden">
    <div class="flex items-center justify-between mb-2">
      <h2 class="text-xl font-bold">🎱 Ziehung – Trommel</h2>
      <div class="badge" id="drumLabel">–</div>
    </div>
    <div id="drumBox" class="glass mb-2"><canvas id="drumCanvas"></canvas></div>
    <div class="flex gap-2 flex-wrap mb-2">
      <button class="btn btn--green" id="startDraw">🎬 Start Ziehung</button>
      <button class="btn btn--amber" id="resetDraw">🔄 Reset</button>
    </div>
    <div class="badge mb-1">Gezogene Hauptzahlen</div>
    <div id="outMain" class="flex flex-wrap"></div>
    <div class="badge mt-3 mb-1">Gezogene Zusatz</div>
    <div id="outExtra" class="flex flex-wrap"></div>
  </div>

  <!-- ANALYSE -->
  <div id="v-ana" class="glass hidden">
    <h2 class="text-xl font-bold mb-2">📊 Analyse</h2>
    <div class="grid grid-cols-2 md:grid-cols-4 gap-2 mb-3">
      <div class="glass"><div class="text-xs text-gray-300">Meistgezogen (Top 5)</div><div id="kpiTop" class="font-bold"></div></div>
      <div class="glass"><div class="text-xs text-gray-300">Selten (Bottom 5)</div><div id="kpiLow" class="font-bold"></div></div>
      <div class="glass"><div class="text-xs text-gray-300">Hot (letzte 20)</div><div id="kpiHot" class="font-bold"></div></div>
      <div class="glass"><div class="text-xs text-gray-300">Top‑Paare</div><div id="kpiPairs" class="font-bold"></div></div>
    </div>
    <canvas id="chartMain" class="w-full h-60 mb-4"></canvas>
    <canvas id="chartExtra" class="w-full h-56"></canvas>
    <div id="analysisBox" class="mt-3 text-sm"></div>
  </div>

<script>
const $ = s => document.querySelector(s);
const $$ = s => Array.from(document.querySelectorAll(s));
const sleep = ms => new Promise(r=>setTimeout(r,ms));
function tab(name, btn){
  ['archiv','map','gen','trommel','ana'].forEach(n=>$('#v-'+n).classList.add('hidden'));
  $('#v-'+name).classList.remove('hidden');
  $$('.nav-btn').forEach(b=>b.classList.remove('active'));
  if(btn) btn.classList.add('active');
}

let currentGame = 'eurojackpot';
const urls = {
  eurojackpot: "https://www.lotto-bayern.de/static/gamebroker_2/de/download_files/archiv_eurojackpot.zip",
  lotto6aus49: "https://www.lotto-bayern.de/static/gamebroker_2/de/download_files/archiv_lotto.zip"
};
const gameConfig = {
  eurojackpot: { mainCount:5, mainMax:50, extraCount:2, extraMax:12, extraName:'Eurozahlen', archKey:'ej_archive_v1' },
  lotto6aus49: { mainCount:6, mainMax:49, extraCount:1, extraMax:9,  extraName:'Superzahl',  archKey:'lz_archive_v1' }
};

// State
let draws=[];
let freqMain=[], freqExtra=[], lastSeenM=[], lastSeenE=[];
let chartMain, chartExtra;

// Init
function applyGameUI(){
  const cfg = gameConfig[currentGame];
  $('#archiveUrl').value = urls[currentGame];
  $('#directDl').href = urls[currentGame];
  $('#mapBadgeMain').textContent = `Hauptzahlen 1–${cfg.mainMax}`;
  $('#mapBadgeExtra').textContent = `${cfg.extraName} ${currentGame==='lotto6aus49'?'0–9':'1–'+cfg.extraMax}`;
  $('#drumLabel').textContent = currentGame==='eurojackpot' ? 'Venus (50) + Pearl (12)' : 'Trommel 49 + Super (0–9)';
  renderMap();
  setKPIs();
}
applyGameUI();

$('#gameSelect').addEventListener('change', (e)=>{
  currentGame = e.target.value;
  // Reset archive stats to avoid cross‑contamination
  draws=[]; freqMain=[]; freqExtra=[];
  applyGameUI();
});

// Map
function renderMap(){
  const cfg = gameConfig[currentGame];
  const m=$('#mapMain'); m.innerHTML='';
  for(let i=1;i<=cfg.mainMax;i++){ const d=document.createElement('div'); d.className='chip'; d.textContent=i; d.dataset.n=i; m.appendChild(d); }
  const e=$('#mapExtra'); e.innerHTML='';
  const startExtra = currentGame==='lotto6aus49' ? 0 : 1;
  for(let i=startExtra;i<=cfg.extraMax;i++){ const d=document.createElement('div'); d.className='chip euro'; d.textContent=i; d.dataset.n=i; e.appendChild(d); }
  $('#progress').textContent='Bereit';
}
function clearMap(){ $$('#mapMain .chip, #mapExtra .chip').forEach(c=>c.classList.remove('sel')); }
async function animateSelection(main, extra){
  tab('map',$('#btn-map')); clearMap(); $('#progress').textContent='Tippt…';
  for(const n of main){ const el=$(`#mapMain .chip[data-n="${n}"]`); if(el){ el.classList.add('sel'); await sleep(120);} }
  for(const n of extra){ const el=$(`#mapExtra .chip[data-n="${n}"]`); if(el){ el.classList.add('sel'); await sleep(120);} }
  $('#progress').textContent='Fertig';
}

// KPIs / Freshness
function setKPIs(){
  if(!draws.length){
    $('#kpiCount').textContent='–'; $('#kpiFrom').textContent='–'; $('#kpiTo').textContent='–'; $('#kpiFresh').textContent='–'; $('#freshLabel').textContent='–';
    return;
  }
  $('#kpiCount').textContent=draws.length;
  $('#kpiFrom').textContent=draws[0].date;
  $('#kpiTo').textContent=draws.at(-1).date;
  const last=new Date(draws.at(-1).date);
  const days=Math.max(0, Math.round((Date.now()-last.getTime())/86400000));
  $('#kpiFresh').textContent = days<=14? 'aktuell' : (days<=60? `ok (${days} Tage alt)` : `veraltet (${days} Tage)`);
  $('#freshLabel').textContent = currentGame==='eurojackpot' ? 'EJ' : '6aus49';
}

// Archive loading
async function ensureJSZip(){ return !!window.JSZip; }
async function fetchWithProxies(url){
  const trials=[url,'https://cors.isomorphic-git.org/'+url,'https://api.allorigins.win/raw?url='+encodeURIComponent(url),'https://thingproxy.freeboard.io/fetch/'+url,'https://corsproxy.io/?'+encodeURIComponent(url)];
  let last=null;
  for(const u of trials){
    try{
      const res=await fetch(u,{cache:'no-store'}); if(!res.ok) throw new Error('HTTP '+res.status);
      const ct=res.headers.get('content-type')||'';
      if(ct.includes('zip') || u.endsWith('.zip')){
        if(!(await ensureJSZip())) throw new Error('JSZip fehlt.');
        const blob=await res.blob(); const zip=await JSZip.loadAsync(blob); const entries=Object.values(zip.files);
        const wanted = entries.filter(f=>/\.(txt|csv)$/i.test(f.name));
        if(!wanted.length) throw new Error('ZIP ohne TXT/CSV');
        let combined=''; for(const f of wanted){ combined += '\\n' + await f.async('string'); }
        return combined;
      } else { return await res.text(); }
    }catch(e){ last=e; }
  }
  throw last||new Error('Download fehlgeschlagen');
}

function parseArchiveText(raw){
  const cfg = gameConfig[currentGame];
  try{
    const lines=raw.replace(/\r\n?/g,'\n').split('\n').map(l=>l.trim()).filter(Boolean);
    const cleaned = lines.filter(l => (l.match(/\d+/g)||[]).length >= (cfg.mainCount + cfg.extraCount));
    function iso(y,m,d){ const dt=new Date(+y, +m-1, +d); return isNaN(dt)? null : dt.toISOString().slice(0,10); }
    const regDMY=/^(\d{1,2})[.\-\/](\d{1,2})[.\-\/](\d{2,4})$/, regYMD=/^(\d{4})[.\-\/](\d{1,2})[.\-\/](\d{1,2})$/;
    function parseLine(line){
      const t=line.split(/;|,|\t|\s+/).filter(Boolean); let date=null,rest=[];
      if(t.length&&regDMY.test(t[0])){const m=t[0].match(regDMY); date=iso(m[3],m[2],m[1]); rest=t.slice(1);}
      else if(t.length&&regYMD.test(t[0])){const m=t[0].match(regYMD); date=iso(m[1],m[2],m[3]); rest=t.slice(1);}
      else{rest=t.slice(0);}
      const nums=rest.map(Number).filter(n=>!Number.isNaN(n));

      // Main numbers
      const main = nums.filter(n=> n>=1 && n<=cfg.mainMax).slice(0,cfg.mainCount).sort((a,b)=>a-b);
      // Extra numbers (EJ 1..12, 6aus49 Super 0..9)
      const extraMin = currentGame==='lotto6aus49' ? 0 : 1;
      const extra = nums.filter(n=> n>=extraMin && n<=cfg.extraMax)
                        .slice(0,cfg.extraCount)
                        .sort((a,b)=>a-b);
      if(!date || main.length!==cfg.mainCount || (cfg.extraCount && extra.length!==cfg.extraCount)) return null;
      return {date,main,extra};
    }
    draws=[]; freqMain=Array(cfg.mainMax+1).fill(0); freqExtra=Array(cfg.extraMax+1).fill(0);
    lastSeenM=Array(cfg.mainMax+1).fill(null); lastSeenE=Array(cfg.extraMax+1).fill(null);
    cleaned.forEach(l=>{ const r=parseLine(l); if(r) draws.push(r); });
    if(!draws.length) throw new Error('Keine gültigen Ziehungen erkannt.');
    draws.sort((a,b)=>a.date.localeCompare(b.date));
    draws.forEach((d,idx)=>{ d.main.forEach(n=>{freqMain[n]++; lastSeenM[n]=idx;}); d.extra.forEach(n=>{freqExtra[n]++; lastSeenE[n]=idx;}); });
    localStorage.setItem(gameConfig[currentGame].archKey, raw);
    $('#statusText').textContent='Archiv geladen ✔';
    setKPIs(); renderCharts(); renderAnalyseKPIs();
  }catch(e){ $('#statusText').textContent='Fehler: '+e.message; }
}

// Buttons
document.getElementById('loadLatestBtn').addEventListener('click', async ()=>{
  const url=$('#archiveUrl').value.trim();
  $('#statusText').textContent='Lade neuestes Archiv…';
  try{ const text=await fetchWithProxies(url); parseArchiveText(text); }
  catch(e){ $('#statusText').innerHTML="Download nicht möglich. <a class='underline' target='_blank' href='"+url+"'>Manuell öffnen</a>."; }
});
document.getElementById('forceDlBtn').addEventListener('click', async ()=>{
  const url=$('#archiveUrl').value.trim();
  try{ const res=await fetch(url); const blob=await res.blob(); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=url.split('/').pop()||'archiv.zip'; a.click(); URL.revokeObjectURL(a.href); }catch(e){ alert('Direkt-Download nicht möglich.'); }
});
document.getElementById('zipInput').addEventListener('change', async (e)=>{
  const file=e.target.files?.[0]; if(!file) return; $('#fileName').textContent=file.name;
  try{
    let text='';
    if(file.name.toLowerCase().endsWith('.zip')){
      if(!(await ensureJSZip())){ alert('JSZip nicht verfügbar.'); return; }
      const zip=await JSZip.loadAsync(file); const entries=Object.values(zip.files);
      let entry=entries.find(f=>/\.(txt|csv)$/i.test(f.name));
      if(!entry) throw new Error('ZIP ohne TXT/CSV.');
      text=await entry.async('string');
    }else{ text=await file.text(); }
    parseArchiveText(text);
  }catch(err){ $('#statusText').textContent='Fehler: '+err.message; }
});

// Analyse (Charts + KPIs)
function renderCharts(){
  if(!draws.length) return;
  if(chartMain) chartMain.destroy(); if(chartExtra) chartExtra.destroy();
  const cfg = gameConfig[currentGame];
  const mainLabels = [...Array(cfg.mainMax+1).keys()].slice(1);
  const extraStart = currentGame==='lotto6aus49'? 0:1;
  const extraLabels = [...Array(cfg.extraMax+1).keys()].slice(extraStart);
  chartMain=new Chart($('#chartMain'),{type:'bar',data:{labels:mainLabels,datasets:[{data:[...freqMain].slice(1), borderWidth:0}]},options:{plugins:{legend:{display:false}}}});
  const dataExtra = extraStart===0 ? [...freqExtra] : [...freqExtra].slice(1);
  chartExtra=new Chart($('#chartExtra'),{type:'bar',data:{labels:extraLabels,datasets:[{data:dataExtra, borderWidth:0}]},options:{plugins:{legend:{display:false}}}});
}
function renderAnalyseKPIs(){
  if(!draws.length) return;
  const cfg = gameConfig[currentGame];
  const mf = [...freqMain].map((v,i)=>[i,v]).slice(1).sort((a,b)=>b[1]-a[1]);
  const lf = [...freqMain].map((v,i)=>[i,v]).slice(1).sort((a,b)=>a[1]-b[1]);
  $('#kpiTop').textContent = mf.slice(0,5).map(x=>x[0]).join(' ');
  $('#kpiLow').textContent = lf.slice(0,5).map(x=>x[0]).join(' ');
  const recent = draws.slice(-20);
  const counts=Array(cfg.mainMax+1).fill(0); recent.forEach(d=>d.main.forEach(n=>counts[n]++));
  const hot = counts.map((v,i)=>[i,v]).slice(1).sort((a,b)=>b[1]-a[1]).slice(0,5).map(x=>x[0]).join(' ');
  $('#kpiHot').textContent = hot;
  const last=draws.slice(-200);
  const map=new Map();
  function inc(k){ map.set(k,(map.get(k)||0)+1); }
  last.forEach(d=>{ const m=[...d.main].sort((a,b)=>a-b); for(let i=0;i<m.length;i++) for(let j=i+1;j<m.length;j++) inc(`${m[i]}-${m[j]}`); });
  const pairs=[...map.entries()].sort((a,b)=>b[1]-a[1]).slice(0,3).map(([k,v])=>k).join('  ');
  $('#kpiPairs').textContent = pairs;
}

// Generator (simplified)
function shuffle(a){ for(let i=a.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1)); [a[i],a[j]]=[a[j],a[i]];} return a; }
function pickFromRange(from,to,avoid,count,weightFn){
  const bag=[]; for(let n=from;n<=to;n++){ if(!avoid.includes(n)){ const w=Math.max(1, weightFn?weightFn(n):1); for(let k=0;k<w;k++) bag.push(n);} }
  shuffle(bag);
  const res=[]; for(const v of bag){ if(!res.includes(v)){ res.push(v); if(res.length===count) break; } }
  return res;
}
function autoExtra(){
  const cfg = gameConfig[currentGame];
  const start = currentGame==='lotto6aus49'? 0 : 1;
  const fe=[...freqExtra]; const maxE=Math.max(...fe.slice(start))||1;
  const lastIdx=draws.length-1;
  const w = (e)=>{
    const f = fe[e]/maxE;
    const gap = lastSeenE[e]!=null ? (lastIdx-lastSeenE[e]) : lastIdx+1;
    const gapN = Math.min(1, gap/(lastIdx+1));
    return 1 + Math.round(3*(0.55*f + 0.45*gapN));
  };
  const need = cfg.extraCount;
  const e = pickFromRange(start,cfg.extraMax,[],need,w).sort((a,b)=>a-b);
  return e;
}
function generateOneSimple(){
  const cfg = gameConfig[currentGame];
  const fm=[...freqMain]; const maxM=Math.max(...fm.slice(1))||1;
  const lastIdx=draws.length-1;
  const w = (n)=>{
    const f = fm[n]/maxM;
    const gap = lastSeenM[n]!=null ? (lastIdx-lastSeenM[n]) : lastIdx+1;
    const gapN = Math.min(1, gap/(lastIdx+1));
    return 1 + Math.round(4*(0.5*f + 0.5*gapN));
  };
  const main = pickFromRange(1,cfg.mainMax,[],cfg.mainCount,w).sort((a,b)=>a-b);
  const extra = autoExtra();
  return {main, extra};
}

document.getElementById('generateBtn').addEventListener('click', ()=>{
  const out=$('#liveOutput'); out.textContent='';
  const k=Math.max(1, Math.min(25, +$('#kombis').value||5));
  for(let i=1;i<=k;i++){
    const tip = generateOneSimple();
    out.textContent += `#${i}: ${tip.main.join(' ')}  |  [${tip.extra.join(' ')}]\\n`;
  }
});
document.getElementById('clearGeneratedBtn').addEventListener('click', ()=>{ $('#liveOutput').textContent=''; $('#cards').innerHTML=''; });

// Trommel (very light simulation)
const Trommel=(function(){
  const canvas = ()=>$('#drumCanvas');
  let cfg={ mainBalls:50, extraBalls:12, drawMain:5, drawExtra:2 };
  function init(opt){
    cfg = Object.assign(cfg,opt||{});
    const c=canvas(); const ctx=c.getContext('2d');
    c.width=c.clientWidth*2; c.height=c.clientHeight*2; ctx.scale(2,2);
    ctx.fillStyle='#0b1022'; ctx.fillRect(0,0,c.clientWidth,c.clientHeight);
    ctx.fillStyle='#9cc3ff'; ctx.font='16px monospace'; ctx.fillText(`Trommel bereit (${cfg.mainBalls} + ${cfg.extraBalls})`, 16, 28);
  }
  function randBag(n, start=1){
    const arr=[]; for(let i=0;i<n;i++) arr.push(i+start);
    for(let i=arr.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [arr[i],arr[j]]=[arr[j],arr[i]]; }
    return arr;
  }
  async function draw(){
    const c=canvas(); const ctx=c.getContext('2d');
    const mainBag = randBag(cfg.mainBalls, 1);
    const extraStart = (currentGame==='lotto6aus49')? 0:1;
    const extraBag = randBag(cfg.extraBalls, extraStart);
    const main = mainBag.slice(0,cfg.drawMain).sort((a,b)=>a-b);
    const extra = extraBag.slice(0,cfg.drawExtra).sort((a,b)=>a-b);
    // simple visuals
    ctx.clearRect(0,0,c.clientWidth,c.clientHeight);
    ctx.fillStyle='#0b1022'; ctx.fillRect(0,0,c.clientWidth,c.clientHeight);
    ctx.fillStyle='#bdfcff'; ctx.font='18px monospace';
    ctx.fillText('Hauptzahlen: '+main.join(' '), 16, 40);
    ctx.fillText('Zusatz: '+extra.join(' '), 16, 68);
    // output chips
    function chip(parent, n, euro=false){
      const d=document.createElement('div'); d.className='chip'+(euro?' euro':''); d.textContent=n; parent.appendChild(d);
    }
    $('#outMain').innerHTML=''; main.forEach(n=>chip($('#outMain'), n, false));
    $('#outExtra').innerHTML=''; extra.forEach(n=>chip($('#outExtra'), n, true));
    await animateSelection(main, extra);
  }
  return { init, draw };
})();
$('#startDraw').addEventListener('click', ()=>{
  const gc = currentGame==='eurojackpot' ? { mainBalls:50, extraBalls:12, drawMain:5, drawExtra:2 }
                                         : { mainBalls:49, extraBalls:10, drawMain:6, drawExtra:1 };
  Trommel.init(gc); Trommel.draw();
});
$('#resetDraw').addEventListener('click', ()=>{
  const gc = currentGame==='eurojackpot' ? { mainBalls:50, extraBalls:12, drawMain:5, drawExtra:2 }
                                         : { mainBalls:49, extraBalls:10, drawMain:6, drawExtra:1 };
  Trommel.init(gc);
});
// first init
Trommel.init({ mainBalls:50, extraBalls:12, drawMain:5, drawExtra:2 });

</script>
</body>
</html>
