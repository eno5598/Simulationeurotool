<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Lotto Merged – Eurojackpot + 6aus49 (ohne iFrame, inkl. Trommel)</title>
<link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
  :root{ --ink:#eaf7ff; --bg:#060712; --hi:#00fff0; --mag:#ff00ea; }
  body{margin:0;background:radial-gradient(900px 700px at -10% -10%, rgba(0,255,240,.12), transparent 60%),
                      radial-gradient(900px 700px at 110% -10%, rgba(255,0,234,.12), transparent 60%), var(--bg);
       color:var(--ink); font-family:Inter, ui-sans-serif, system-ui;}
  .title{background:linear-gradient(90deg,var(--hi),var(--mag)); -webkit-background-clip:text; color:transparent; font-weight:900}
  .glass{background:rgba(15,18,40,.78); border:1px solid rgba(0,255,255,.18); border-radius:14px; padding:14px; box-shadow:0 12px 40px rgba(0,0,0,.45)}
  .navbtn{display:flex;gap:.5rem;align-items:center;justify-content:center;height:40px;padding:0 12px;border-radius:10px;border:1px solid rgba(255,255,255,.08);background:#1f2937;color:#fff}
  .navbtn.active{outline:2px solid rgba(255,255,255,.15); box-shadow:0 0 14px rgba(0,255,240,.32)}
  .btn{display:inline-flex;align-items:center;justify-content:center;gap:.5rem;height:40px;padding:0 12px;border-radius:10px;border:1px solid rgba(255,255,255,.08);background:#15803d;color:#fff}
  .btn.gray{background:#374151} .btn.amber{background:#b45309}
  .file{display:none}
  .chip{display:inline-flex;align-items:center;justify-content:center;min-width:32px;height:32px;border-radius:10px;margin:4px;font-weight:800;font-size:.9rem;color:#bdfcff;background:linear-gradient(180deg,#0e1530,#15204a);border:1px solid rgba(0,255,255,.25)}
  .chip.extra{color:#ffe6ff;background:linear-gradient(180deg,#1c1433,#1c2b53);border-color:rgba(255,0,234,.3)}
  .chip.sel{background:linear-gradient(180deg,rgba(0,255,240,.25),rgba(0,255,240,.05)); box-shadow:0 0 12px rgba(0,255,240,.35), inset 0 0 0 1px rgba(0,255,255,.45)}
  canvas{max-width:100%}
  .hidden{display:none}
</style>
</head>
<body class="p-4">
  <div class="flex items-center justify-between mb-3 gap-2 flex-wrap">
    <h1 class="title text-3xl md:text-4xl">Lotto Merged</h1>
    <div class="flex items-center gap-2">
      <span class="bg-white/10 rounded px-2 py-1 text-sm">Spiel</span>
      <select id="game" class="bg-gray-900 p-2 rounded">
        <option value="ej" selected>Eurojackpot</option>
        <option value="lz">6 aus 49 (Bayern)</option>
      </select>
    </div>
  </div>

  <div class="flex gap-2 flex-wrap mb-4">
    <button class="navbtn active" data-tab="archiv">📂 Archiv</button>
    <button class="navbtn" data-tab="map">🗺️ Map</button>
    <button class="navbtn" data-tab="gen">⚡ Generator</button>
    <button class="navbtn" data-tab="ana">📊 Analyse</button>
    <button class="navbtn" data-tab="trommel">🔮 Trommel</button>
  </div>

  <!-- ARCHIV -->
  <section id="tab-archiv" class="glass">
    <div class="flex items-center justify-between mb-2">
      <h2 class="font-bold text-xl">📂 Archiv</h2>
      <div id="freshBadge" class="bg-white/10 rounded px-2 py-1 text-sm">–</div>
    </div>

    <div id="err" class="hidden bg-red-900/40 border border-red-400 text-red-200 rounded px-2 py-1 mb-2 text-sm"></div>
    <p id="status" class="text-sm mb-2">Noch kein Archiv geladen.</p>

    <div class="glass mb-3">
      <div class="flex flex-col md:flex-row gap-2">
        <input id="archiveUrl" class="bg-gray-900 p-2 rounded flex-1">
        <button id="loadLatest" class="btn">📥 Neueste laden</button>
        <button id="forceDl" class="btn amber">⬇️ ZIP speichern</button>
        <a id="directDl" class="btn gray" target="_blank" rel="noopener">🔗 Direktlink</a>
        <label class="btn gray" style="cursor:pointer">📄 Datei<input id="file" type="file" class="file" accept=".zip,.txt,.csv"></label>
        <button id="sample" class="btn gray">🧪 Beispiel</button>
      </div>
      <p class="text-xs opacity-75 mt-2">Bayern-Archiv: EJ = archiv_eurojackpot.zip · 6aus49 = archiv_lotto.zip</p>
    </div>

    <div class="grid grid-cols-2 md:grid-cols-4 gap-2 text-center">
      <div><div class="text-sm opacity-75">Ziehungen</div><div id="kpiCount" class="font-bold">–</div></div>
      <div><div class="text-sm opacity-75">Von</div><div id="kpiFrom" class="font-bold">–</div></div>
      <div><div class="text-sm opacity-75">Bis</div><div id="kpiTo" class="font-bold">–</div></div>
      <div><div class="text-sm opacity-75">Aktualität</div><div id="kpiFresh" class="font-bold">–</div></div>
    </div>
  </section>

  <!-- MAP -->
  <section id="tab-map" class="glass hidden">
    <div class="flex items-center justify-between mb-1">
      <h2 class="text-xl font-bold">🗺 Map</h2>
      <div id="progress" class="bg-white/10 rounded px-2 py-1 text-sm">Bereit</div>
    </div>
    <div class="mb-1 bg-white/10 rounded px-2 py-1 text-sm" id="mainLabel">Hauptzahlen</div>
    <div id="mapMain" class="flex flex-wrap"></div>
    <div class="mt-3 bg-white/10 rounded px-2 py-1 text-sm" id="extraLabel">Eurozahlen</div>
    <div id="mapExtra" class="flex flex-wrap"></div>
  </section>

  <!-- GENERATOR -->
  <section id="tab-gen" class="glass hidden">
    <h2 class="text-xl font-bold mb-2">⚡ Generator</h2>
    <div class="grid grid-cols-1 md:grid-cols-3 gap-2">
      <select id="modus" class="bg-gray-900 p-2 rounded">
        <option value="last100">Letzte 100</option>
        <option value="never">Nie gezogene</option>
        <option value="hot">Hot Paare & Triples</option>
      </select>
      <input id="outCount" type="number" class="bg-gray-900 p-2 rounded" value="5" min="1" max="25">
      <div class="flex gap-2">
        <button id="gen" class="btn">⚡ Generieren</button>
        <button id="genClear" class="btn gray">🗑️ Löschen</button>
      </div>
    </div>
    <pre id="genOut" class="font-mono bg-black/60 p-3 mt-2 rounded h-44 overflow-auto text-green-300"></pre>
  </section>

  <!-- ANALYSE -->
  <section id="tab-ana" class="glass hidden">
    <h2 class="text-xl font-bold mb-2">📊 Analyse</h2>
    <canvas id="chartMain" class="w-full h-56 mb-4"></canvas>
    <canvas id="chartExtra" class="w-full h-52"></canvas>
  </section>

  <!-- TROMMEL -->
  <section id="tab-trommel" class="glass hidden">
    <div class="flex items-center justify-between mb-2">
      <h2 class="text-xl font-bold">🔮 Trommel</h2>
      <button id="drumStart" class="btn">Start</button>
    </div>
    <canvas id="drum" width="640" height="240" class="w-full rounded border border-white/10 bg-black/40"></canvas>
    <div id="drumOut" class="mt-2 font-mono"></div>
  </section>

<script>
// ========= Helper =========
const $=s=>document.querySelector(s);
const $$=s=>Array.from(document.querySelectorAll(s));
const sleep=ms=>new Promise(r=>setTimeout(r,ms));

// ========= Tabs =========
$$('.navbtn').forEach(b=>b.addEventListener('click',()=>{
  $$('.navbtn').forEach(x=>x.classList.remove('active')); b.classList.add('active');
  const id=b.dataset.tab;
  ['archiv','map','gen','ana','trommel'].forEach(n=>$('#tab-'+n).classList.toggle('hidden', n!==id));
}));

// ========= Game config =========
let game='ej';
const urls={ ej:'https://www.lotto-bayern.de/static/gamebroker_2/de/download_files/archiv_eurojackpot.zip',
             lz:'https://www.lotto-bayern.de/static/gamebroker_2/de/download_files/archiv_lotto.zip' };
const cfgs={
  ej:{ mainMax:50, mainCount:5, extraMin:1, extraMax:12, extraCount:2, extraName:'Eurozahlen' },
  lz:{ mainMax:49, mainCount:6, extraMin:0, extraMax:9,  extraCount:1, extraName:'Superzahl' }
};

$('#game').addEventListener('change', e=>{ game=e.target.value; applyGame(); });
function applyGame(){
  const c=cfgs[game];
  $('#archiveUrl').value=urls[game]; $('#directDl').href=urls[game];
  $('#mainLabel').textContent=`Hauptzahlen 1–${c.mainMax}`;
  $('#extraLabel').textContent=`${c.extraName} ${c.extraMin}–${c.extraMax}`;
  renderMap(); setKPIs(); if(chartMain) chartMain.destroy(); if(chartExtra) chartExtra.destroy();
}
applyGame();

// ========= Archiv laden =========
let draws=[], freqMain=[], freqExtra=[], lastSeenM=[], lastSeenE=[];
let chartMain, chartExtra;

function showErr(msg){ const el=$('#err'); el.textContent=msg; el.classList.remove('hidden'); console.error(msg); }
function clearErr(){ $('#err').classList.add('hidden'); }

async function ensureJSZip(){ return !!window.JSZip; }
async function fetchWithProxies(url){
  const trials=[url,'https://cors.isomorphic-git.org/'+url,'https://api.allorigins.win/raw?url='+encodeURIComponent(url),'https://thingproxy.freeboard.io/fetch/'+url,'https://corsproxy.io/?'+encodeURIComponent(url)];
  let last=null; for(const u of trials){
    try{ const res=await fetch(u,{cache:'no-store'}); if(!res.ok) throw new Error('HTTP '+res.status);
      const ct=res.headers.get('content-type')||'';
      if(ct.includes('zip') || u.endsWith('.zip')){
        if(!(await ensureJSZip())) throw new Error('JSZip fehlt.');
        const blob=await res.blob(); const zip=await JSZip.loadAsync(blob);
        const entries=Object.values(zip.files).filter(f=>/\.(txt|csv)$/i.test(f.name));
        if(!entries.length) throw new Error('ZIP ohne TXT/CSV.');
        let combined=''; for(const f of entries){ combined+='\\n'+await f.async('string'); }
        return combined;
      }else{ return await res.text(); }
    }catch(e){ last=e; }
  } throw last||new Error('Download fehlgeschlagen');
}

function parseArchiveText(raw){
  const c=cfgs[game];
  try{
    const lines=raw.replace(/\\r\\n?/g,'\\n').split('\\n').map(l=>l.trim()).filter(Boolean);
    const cleaned=lines.filter(l => (l.match(/\\d+/g)||[]).length >= (c.mainCount + c.extraCount));
    function iso(y,m,d){ const dt=new Date(+y, +m-1, +d); return isNaN(dt)? null : dt.toISOString().slice(0,10); }
    const dmy=/^(\\d{1,2})[.\\-\\/](\\d{1,2})[.\\-\\/](\\d{2,4})$/, ymd=/^(\\d{4})[.\\-\\/](\\d{1,2})[.\\-\\/](\\d{1,2})$/;
    function parseLine(line){
      const t=line.split(/;|,|\\t|\\s+/).filter(Boolean); let date=null,rest=[];
      if(t.length && dmy.test(t[0])){ const m=t[0].match(dmy); date=iso(m[3],m[2],m[1]); rest=t.slice(1); }
      else if(t.length && ymd.test(t[0])){ const m=t[0].match(ymd); date=iso(m[1],m[2],m[3]); rest=t.slice(1); }
      else{ rest=t.slice(0); }
      const nums=rest.map(Number).filter(n=>!Number.isNaN(n));
      const main = nums.filter(n=> n>=1 && n<=c.mainMax).slice(0,c.mainCount).sort((a,b)=>a-b);
      const extra = nums.filter(n=> n>=c.extraMin && n<=c.extraMax).slice(0,c.extraCount).sort((a,b)=>a-b);
      if(!date || main.length!==c.mainCount || (c.extraCount && extra.length!==c.extraCount)) return null;
      return {date,main,extra};
    }
    draws=[]; freqMain=Array(c.mainMax+1).fill(0); freqExtra=Array(c.extraMax+1).fill(0);
    lastSeenM=Array(c.mainMax+1).fill(null); lastSeenE=Array(c.extraMax+1).fill(null);
    cleaned.forEach(l=>{ const r=parseLine(l); if(r) draws.push(r); });
    if(!draws.length) throw new Error('Keine gültigen Ziehungen erkannt.');
    draws.sort((a,b)=>a.date.localeCompare(b.date));
    draws.forEach((d,idx)=>{ d.main.forEach(n=>{freqMain[n]++; lastSeenM[n]=idx;}); d.extra.forEach(n=>{freqExtra[n]++; lastSeenE[n]=idx;}); });
    $('#status').textContent='Archiv geladen ✔'; setKPIs(); renderCharts(); clearErr();
  }catch(e){ $('#status').textContent='Fehler beim Parsen'; showErr(e.message||String(e)); }
}

$('#loadLatest').addEventListener('click', async()=>{
  const url=$('#archiveUrl').value.trim(); $('#status').textContent='Lade…'; clearErr();
  try{ const text=await fetchWithProxies(url); parseArchiveText(text); }catch(e){ $('#status').textContent='Download fehlgeschlagen'; showErr(e?.message||String(e)); }
});
$('#forceDl').addEventListener('click', async()=>{
  const url=$('#archiveUrl').value.trim();
  try{ const res=await fetch(url); const blob=await res.blob(); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=url.split('/').pop()||'archiv.zip'; a.click(); URL.revokeObjectURL(a.href);}catch(e){ showErr('Direkt-Download nicht möglich: '+(e?.message||e)); }
});
$('#file').addEventListener('change', async (e)=>{
  const f=e.target.files?.[0]; if(!f) return; clearErr();
  try{
    let text=''; if(f.name.toLowerCase().endsWith('.zip')){
      if(!(await ensureJSZip())){ showErr('JSZip fehlt'); return; }
      const zip=await JSZip.loadAsync(f); const entries=Object.values(zip.files).filter(x=>/\\.(txt|csv)$/i.test(x.name));
      if(!entries.length) throw new Error('ZIP ohne TXT/CSV');
      text=await entries[0].async('string');
    }else{ text=await f.text(); }
    parseArchiveText(text);
  }catch(err){ showErr(err?.message||String(err)); }
});
$('#sample').addEventListener('click',()=>{
  const ej=`
  2024-09-06; 4; 11; 24; 35; 48; 3; 7
  2024-09-13; 8; 16; 17; 36; 49; 4; 9
  2024-09-20; 2; 10; 19; 22; 28; 1; 6
  2024-09-27; 7; 12; 25; 31; 44; 2; 8
  2024-10-04; 5; 15; 18; 29; 47; 3; 12
  2024-10-11; 6; 9; 13; 26; 33; 5; 10
  2024-10-18; 1; 14; 23; 32; 40; 7; 11
  2024-10-25; 3; 20; 27; 34; 41; 2; 9
  2024-11-01; 16; 21; 30; 38; 45; 1; 5
  2024-11-08; 11; 19; 22; 28; 50; 4; 6`;
  const lz=`
  06.09.2024; 4; 11; 24; 35; 48; 49; 7
  13.09.2024; 8; 16; 17; 36; 42; 44; 0
  20.09.2024; 2; 10; 19; 22; 28; 33; 3
  27.09.2024; 7; 12; 25; 31; 41; 45; 5
  04.10.2024; 5; 15; 18; 29; 37; 47; 9
  11.10.2024; 6; 9; 13; 26; 33; 39; 2
  18.10.2024; 1; 14; 23; 32; 40; 46; 4
  25.10.2024; 3; 20; 27; 34; 41; 43; 1
  01.11.2024; 16; 21; 30; 38; 45; 49; 6
  08.11.2024; 11; 19; 22; 28; 35; 44; 8`;
  parseArchiveText(game==='ej'?ej:lz); $('#status').textContent='Beispiel geladen ✔';
});

function setKPIs(){
  if(!draws.length){ $('#kpiCount').textContent='–'; $('#kpiFrom').textContent='–'; $('#kpiTo').textContent='–'; $('#kpiFresh').textContent='–'; return; }
  $('#kpiCount').textContent=draws.length; $('#kpiFrom').textContent=draws[0].date; $('#kpiTo').textContent=draws.at(-1).date;
  const d=new Date(draws.at(-1).date); const days=Math.max(0, Math.round((Date.now()-d)/86400000));
  $('#kpiFresh').textContent= days<=14? 'aktuell' : (days<=60? 'ok ('+days+' Tage)' : 'veraltet ('+days+' Tage)');
}

function renderMap(){
  const c=cfgs[game];
  const m=$('#mapMain'); m.innerHTML='';
  for(let i=1;i<=c.mainMax;i++){ const d=document.createElement('div'); d.className='chip'; d.textContent=i; m.appendChild(d); }
  const e=$('#mapExtra'); e.innerHTML='';
  for(let i=c.extraMin;i<=c.extraMax;i++){ const d=document.createElement('div'); d.className='chip extra'; d.textContent=i; e.appendChild(d); }
  $('#progress').textContent='Bereit';
}

function renderCharts(){
  if(chartMain) chartMain.destroy(); if(chartExtra) chartExtra.destroy();
  const c=cfgs[game];
  const mainLabels=[...Array(c.mainMax).keys()].map(i=>i+1);
  const extraLabels=[...Array(c.extraMax-c.extraMin+1).keys()].map(i=>i+c.extraMin);
  chartMain=new Chart($('#chartMain'),{type:'bar',data:{labels:mainLabels,datasets:[{data:[...freqMain].slice(1),borderWidth:0}]},options:{plugins:{legend:{display:false}}}});
  const exData = c.extraMin===0 ? [...freqExtra] : [...freqExtra].slice(c.extraMin);
  chartExtra=new Chart($('#chartExtra'),{type:'bar',data:{labels:extraLabels,datasets:[{data:exData,borderWidth:0}]},options:{plugins:{legend:{display:false}}}});
}

// ========= Generator =========
function shuffle(a){ for(let i=a.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1)); [a[i],a[j]]=[a[j],a[i]];} return a; }
function pickFromRange(from,to,avoid,count,weightFn){
  const bag=[]; for(let n=from;n<=to;n++){ if(!avoid.includes(n)){ const w=Math.max(1, weightFn?weightFn(n):1); for(let k=0;k<w;k++) bag.push(n);} }
  shuffle(bag); const res=[]; for(const v of bag){ if(!res.includes(v)){ res.push(v); if(res.length===count) break; } } return res;
}
function autoExtra(){
  const c=cfgs[game]; const start=c.extraMin; const fe=[...freqExtra]; const maxE=Math.max(...fe.slice(start))||1; const last=draws.length-1;
  const w=e=>{ const f=fe[e]/maxE; const gap=lastSeenE[e]!=null ? (last-lastSeenE[e]) : last+1; const gn=Math.min(1, gap/(last+1)); return 1 + Math.round(3*(0.55*f+0.45*gn)); };
  return pickFromRange(start,c.extraMax,[],c.extraCount,w).sort((a,b)=>a-b);
}
function genOne(){
  const c=cfgs[game];
  if(!draws.length){ return {main:pickFromRange(1,c.mainMax,[],c.mainCount).sort((a,b)=>a-b), extra:pickFromRange(c.extraMin,c.extraMax,[],c.extraCount)}; }
  const mode=$('#modus').value;
  if(mode==='last100'){
    const r=draws.slice(-100); const fm=Array(c.mainMax+1).fill(1); r.forEach(d=>d.main.forEach(n=>fm[n]++));
    const maxM=Math.max(...fm.slice(1)); const w=n=>Math.ceil(3*fm[n]/maxM);
    return {main:pickFromRange(1,c.mainMax,[],c.mainCount,w).sort((a,b)=>a-b), extra:autoExtra()};
  }
  if(mode==='never'){
    const fm=[...freqMain]; const w=n=> fm[n]===0?5:(fm[n]<=5?3:1);
    return {main:pickFromRange(1,c.mainMax,[],c.mainCount,w).sort((a,b)=>a-b), extra:autoExtra()};
  }
  // hot
  const recent = draws.slice(-200); const pair=new Map(), trip=new Map(); const inc=(m,k)=>m.set(k,(m.get(k)||0)+1);
  for(const d of recent){ const m=[...d.main].sort((a,b)=>a-b);
    for(let i=0;i<m.length;i++) for(let j=i+1;j<m.length;j++) inc(pair,`${m[i]}-${m[j]}`);
    for(let i=0;i<m.length;i++) for(let j=i+1;j<m.length;j++) for(let k=j+1;k<m.length;k++) inc(trip,`${m[i]}-${m[j]}-${m[k]}`);
  }
  const tPairs=[...pair.entries()].sort((a,b)=>b[1]-a[1]).slice(0,30).map(e=>e[0].split('-').map(Number));
  const tTrip=[...trip.entries()].sort((a,b)=>b[1]-a[1]).slice(0,20).map(e=>e[0].split('-').map(Number));
  let m=[]; if(Math.random()<0.5 && tTrip.length) m=[...tTrip[Math.floor(Math.random()*tTrip.length)]]; else if(tPairs.length) m=[...tPairs[Math.floor(Math.random()*tPairs.length)]];
  const r2=draws.slice(-100); const fm=Array(c.mainMax+1).fill(1); r2.forEach(d=>d.main.forEach(n=>fm[n]++)); const maxM=Math.max(...fm.slice(1)); const w=n=>Math.ceil(2*fm[n]/maxM);
  while(m.length<c.mainCount){ const add=pickFromRange(1,c.mainMax,m,1,w); if(add.length) m.push(add[0]); else break; } m.sort((a,b)=>a-b);
  return {main:m, extra:autoExtra()};
}
$('#gen').addEventListener('click',()=>{
  if(!draws.length){ alert('Bitte zuerst Archiv laden (oder Beispiel).'); return; }
  const out=$('#genOut'); out.textContent=''; const k=Math.max(1,Math.min(25,+$('#outCount').value||5));
  for(let i=1;i<=k;i++){ const t=genOne(); out.textContent+=`#${i}: ${t.main.join(' ')}  |  [${t.extra.join(' ')}]\\n`; }
});
$('#genClear').addEventListener('click',()=>$('#genOut').textContent='');

// ========= Trommel (2D Animation) =========
const cvs=$('#drum'), ctx=cvs.getContext('2d');
function drumDraw(balls, pick, extraPick){
  const c=cfgs[game]; const W=cvs.width, H=cvs.height; const R=14;
  let pos=balls.map((n,i)=>({n,x:Math.random()*W*0.9+20,y:Math.random()*H*0.8+20, vx:(Math.random()*2-1)*2, vy:(Math.random()*2-1)*2}));
  let picks=[], epicks=[]; let frame=0, done=false;
  function step(){
    ctx.clearRect(0,0,W,H);
    // border
    ctx.strokeStyle='rgba(255,255,255,.25)'; ctx.strokeRect(1,1,W-2,H-2);
    // physics-lite
    for(const p of pos){
      p.x+=p.vx; p.y+=p.vy; p.vy+=0.04;
      if(p.x<R||p.x>W-R) p.vx*=-1;
      if(p.y<R||p.y>H-R){ p.vy*=-0.9; p.y=Math.min(Math.max(p.y,R),H-R); }
    }
    // collisions (rough)
    for(let i=0;i<pos.length;i++) for(let j=i+1;j<pos.length;j++){
      const a=pos[i], b=pos[j]; const dx=a.x-b.x, dy=a.y-b.y; const d=Math.hypot(dx,dy);
      if(d<2*R){ const nx=dx/d, ny=dy/d; const ov=2*R-d; a.x+=nx*ov/2; a.y+=ny*ov/2; b.x-=nx*ov/2; b.y-=ny*ov/2; const vax=a.vx, vay=a.vy; a.vx=b.vx; a.vy=b.vy; b.vx=vax; b.vy=vay; }
    }
    // draw balls
    for(const p of pos){
      ctx.beginPath(); ctx.arc(p.x,p.y,R,0,Math.PI*2); ctx.fillStyle='rgba(0,255,240,.25)'; ctx.fill();
      ctx.fillStyle='#eaf7ff'; ctx.font='bold 12px ui-sans-serif'; ctx.textAlign='center'; ctx.textBaseline='middle'; ctx.fillText(p.n, p.x, p.y);
    }
    // selection timeline
    if(frame%40===0 && (picks.length<c.mainCount || epicks.length<c.extraCount)){
      if(picks.length<c.mainCount){ const n=pick(); picks.push(n); }
      else if(epicks.length<c.extraCount){ const n=extraPick(); epicks.push(n); }
      $('#drumOut').textContent = `Haupt: ${picks.join(' ')}   |   Extra: [${epicks.join(' ')}]`;
    }
    frame++; if(frame<1200 && (picks.length<c.mainCount || epicks.length<c.extraCount)) requestAnimationFrame(step);
    else if(!done){ done=true; $('#drumOut').textContent += '  ✔'; }
  }
  step();
}

$('#drumStart').addEventListener('click',()=>{
  if(!draws.length){ alert('Bitte zuerst Archiv laden (oder Beispiel).'); return; }
  const c=cfgs[game];
  // bag from frequencies (favor less recently drawn numbers slightly)
  const last=draws.length-1; const gapM=Array(c.mainMax+1).fill(last+1); for(let n=1;n<=c.mainMax;n++){ if(lastSeenM[n]!=null) gapM[n]=last-lastSeenM[n]; }
  const gapE=Array(c.extraMax+1).fill(last+1); for(let n=c.extraMin;n<=c.extraMax;n++){ if(lastSeenE[n]!=null) gapE[n]=last-lastSeenE[n]; }
  const wM=n=>1+Math.round(4*(gapM[n]/Math.max(...gapM.slice(1)))); const wE=n=>1+Math.round(3*(gapE[n]/Math.max(...gapE.slice(c.extraMin))));
  const pickMain=(()=>{ const used=new Set(); return ()=>{ let n; do{ n=pickFromRange(1,c.mainMax,[...used],1,wM)[0]; }while(used.has(n)); used.add(n); return n; }; })();
  const pickExtra=(()=>{ const used=new Set(); return ()=>{ let n; do{ n=pickFromRange(c.extraMin,c.extraMax,[...used],1,wE)[0]; }while(used.has(n)); used.add(n); return n; }; })();
  const balls=[...Array(c.mainMax).keys()].map(i=>i+1);
  drumDraw(balls, pickMain, pickExtra);
});

// ========= init =========
function init(){ $('#archiveUrl').value=urls[game]; $('#directDl').href=urls[game]; renderMap(); }
init();
</script>
</body>
</html>
