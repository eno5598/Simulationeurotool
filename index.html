<!doctype html>
<html lang="de">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>EuroJackpot ‚Ä¢ Premium Ziehung v2 (fix: Containment & Clean Look)</title>
<link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/matter-js@0.19.0/build/matter.min.js"></script>
<style>
:root{ --ink:#eaf7ff; --bg:#070a14; --panel:rgba(13,19,38,.78); --cy:#01ffee; --mag:#ff4ee4;}
body{margin:0;color:var(--ink);font-family:Inter,ui-sans-serif,system-ui;background:
  radial-gradient(1200px 800px at -10% -10%, rgba(0,255,240,.10), transparent 60%),
  radial-gradient(1200px 800px at 110% -10%, rgba(255,0,234,.10), transparent 60%),
  linear-gradient(180deg,#060a12,#05070e 60%, #060a12);}
.h1{background:linear-gradient(90deg,var(--cy),var(--mag));-webkit-background-clip:text;color:transparent;font-weight:900}
.card{background:var(--panel);backdrop-filter:blur(14px);border:1px solid rgba(255,255,255,.08);border-radius:14px;padding:14px;box-shadow:0 14px 44px rgba(0,0,0,.45)}
.btn{display:inline-flex;align-items:center;justify-content:center;gap:.5rem;height:44px;padding:0 12px;border-radius:12px;border:1px solid rgba(255,255,255,.08);font-weight:700}
.btn--green{background:#15803d;color:#fff}.btn--amber{background:#b45309;color:#fff}.btn--gray{background:#374151;color:#fff}
.grid2{display:grid;grid-template-columns:1fr;gap:14px}@media(min-width:900px){.grid2{grid-template-columns:1fr 1fr}}
.simwrap{position:relative;border-radius:12px;overflow:hidden;border:1px solid rgba(255,255,255,.08);background:#03070e}
.simwrap canvas{width:100%;height:420px;max-height:62vh;background:radial-gradient(70% 90% at 50% 35%, #0b1626, #071220, #050c18)}
.label{position:absolute;top:10px;left:12px;font-size:14px;opacity:.85}
.bubble{display:inline-block;padding:3px 9px;border-radius:999px;background:rgba(0,0,0,.35);border:1px solid rgba(255,255,255,.12)}
.slot{position:absolute;right:10px;top:10px;width:92px;height:92px;border-radius:14px;border:1px solid rgba(0,255,200,.28);background:linear-gradient(180deg,rgba(0,255,170,.12),rgba(0,140,120,.10));display:flex;align-items:center;justify-content:center;font-size:12px;color:#8bffc9;box-shadow:inset 0 0 18px rgba(0,255,200,.08)}
.badge{background:rgba(255,255,255,.06);border:1px solid rgba(140,170,255,.22);border-radius:999px;padding:.2rem .6rem;font-size:.78rem}
.chip{display:inline-flex;align-items:center;justify-content:center;min-width:36px;height:36px;border-radius:999px;background:linear-gradient(180deg,#0fd5c6,#0aa39a);box-shadow:inset 0 -6px 10px rgba(0,0,0,.2),0 10px 20px rgba(0,0,0,.35);font-weight:800}
.chip--gold{background:linear-gradient(180deg,#ffe7a2,#f4c655);color:#241a05;box-shadow:inset 0 -6px 10px rgba(0,0,0,.15),0 10px 22px rgba(255,220,130,.25)}
</style>
</head>
<body class="p-4">
  <h1 class="h1 text-3xl md:text-4xl mb-3">EuroJackpot ‚Ä¢ Premium Ziehung v2</h1>
  <div class="grid grid-cols-1 xl:grid-cols-3 gap-3">
    <section class="card xl:col-span-2">
      <h2 class="font-bold text-xl mb-2">üåÄ Simulation (sauberes Containment + Clip-Maske)</h2>
      <div class="grid2">
        <div class="simwrap">
          <div class="label"><span class="bubble">Haupttrommel (1‚Äì50)</span></div>
          <div class="slot">Auswurf</div>
          <canvas id="canvasA" width="680" height="420"></canvas>
        </div>
        <div class="simwrap">
          <div class="label"><span class="bubble">Eurotrommel (1‚Äì12)</span></div>
          <div class="slot">Auswurf</div>
          <canvas id="canvasB" width="680" height="420"></canvas>
        </div>
      </div>
      <div class="flex flex-wrap gap-2 mt-2">
        <button id="btnStartDraw" class="btn btn--green">Ziehung starten (5+2)</button>
        <button id="btnStop" class="btn btn--gray">Stop</button>
        <button id="btnReset" class="btn btn--amber">Reset</button>
      </div>
      <div id="result" class="mt-3 text-lg"><span class="badge">Noch kein Ergebnis</span></div>
      <div id="pickedList" class="mt-2 text-sm"></div>
    </section>

    <section class="card">
      <h2 class="font-bold text-xl mb-2">üìÇ Archiv (Auto + Fallback)</h2>
      <div class="mb-2">
        <input id="archiveUrl" class="bg-gray-900 p-2 rounded w-full" value="https://www.lotto-bayern.de/static/gamebroker_2/de/download_files/archiv_eurojackpot.zip">
      </div>
      <div class="flex flex-wrap gap-2 mb-2">
        <button id="loadLatestBtn" class="btn btn--green">üì• Neueste laden</button>
        <button id="forceDlBtn" class="btn btn--amber">‚¨áÔ∏è ZIP speichern</button>
        <a id="directDl" class="btn btn--gray" target="_blank" rel="noopener">üîó Direktlink</a>
      </div>
      <div class="grid grid-cols-2 gap-2 text-center my-2">
        <div class="badge">Ziehungen: <b id="kpiCount">‚Äì</b></div>
        <div class="badge">Bis: <b id="kpiTo">‚Äì</b></div>
      </div>
      <div class="flex flex-wrap gap-2 mb-2">
        <label class="btn btn--gray cursor-pointer">üìÑ Datei w√§hlen
          <input id="zipInput" type="file" class="hidden" accept=".zip,.txt,.csv">
        </label>
        <button id="pasteBtn" class="btn btn--gray">üìã CSV/TXT einf√ºgen</button>
      </div>
      <div id="statusText" class="text-xs opacity-80">Noch kein Archiv geladen.</div>
    </section>
  </div>

<script>
/* ===== Archiv Loader (wie gehabt, kurz) ===== */
const LS_ARCH='ej_archive_v7', $=s=>document.querySelector(s);
async function withProxies(url){const T=[url,'https://cors.isomorphic-git.org/'+url,'https://api.allorigins.win/raw?url='+encodeURIComponent(url),'https://thingproxy.freeboard.io/fetch/'+url,'https://corsproxy.io/?'+encodeURIComponent(url)];for(const u of T){try{const r=await fetch(u,{cache:'no-store'});if(!r.ok)throw 0;const ct=r.headers.get('content-type')||'';if(ct.includes('zip')||u.endsWith('.zip')){const b=await r.blob();const z=await JSZip.loadAsync(b);let s='';for(const f of Object.values(z.files)){if(/\\.(txt|csv)$/i.test(f.name))s+='\\n'+await f.async('string');}return s;}else return await r.text();}catch{}}throw new Error('Download fehlgeschlagen');}
function parseText(t){try{t=t.replace(/\\r\\n?/g,'\\n');const head=t.slice(0,2e3);const d=(head.match(/\\t/g)||[]).length>(head.match(/;/g)||[]).length?'\\t':(head.match(/;/g)||[]).length?';':',';const L=t.split('\\n').map(l=>l.trim()).filter(Boolean);const H=L[0].split(d).map(x=>x.trim());const id={Tag:H.findIndex(x=>/tag/i.test(x)),Monat:H.findIndex(x=>/monat|month/i.test(x)),Jahr:H.findIndex(x=>/jahr|year/i.test(x)),A:[1,2,3,4,5].map(k=>H.findIndex(x=>new RegExp('ZahlA'+k,'i').test(x))),B:[1,2].map(k=>H.findIndex(x=>new RegExp('ZahlB'+k,'i').test(x)))};if(id.Tag<0||id.Monat<0||id.Jahr<0||id.A.some(i=>i<0)||id.B.some(i=>i<0)) throw 0;const out=[];for(let i=1;i<L.length;i++){const c=L[i].split(d).map(s=>s.trim());if(c.length<=Math.max(...id.A,...id.B))continue;const A=id.A.map(ii=>+c[ii]).filter(Number.isFinite),B=id.B.map(ii=>+c[ii]).filter(Number.isFinite);const day=+c[id.Tag],mon=+c[id.Monat],year=+c[id.Jahr];if(A.length===5&&B.length===2){const date=new Date(Date.UTC(year,mon-1,day)).toISOString().slice(0,10);out.push({date,main:A.slice().sort((a,b)=>a-b),euro:B.slice().sort((a,b)=>a-b)})}}out.sort((a,b)=>a.date.localeCompare(b.date));$('#kpiCount').textContent=out.length;$('#kpiTo').textContent=out.at(-1)?.date||'‚Äì';$('#statusText').textContent='Archiv geladen ‚úî';return out;}catch(e){$('#statusText').textContent='Archiv nicht erkannt';return []}}
document.getElementById('loadLatestBtn').onclick=async()=>{try{const raw=await withProxies($('#archiveUrl').value.trim());parseText(raw);localStorage.setItem(LS_ARCH,raw);}catch(e){const s=localStorage.getItem(LS_ARCH);if(s){parseText(s);$('#statusText').textContent='Fallback: lokale Kopie.'}else{$('#statusText').textContent='Kein Archiv verf√ºgbar.'}}};
document.getElementById('forceDlBtn').onclick=async()=>{try{const r=await fetch($('#archiveUrl').value.trim());const b=await r.blob();const a=document.createElement('a');a.href=URL.createObjectURL(b);a.download='archiv_eurojackpot.zip';a.click();}catch{alert('Direkt-Download nicht m√∂glich.')}};
document.getElementById('directDl').href=$('#archiveUrl').value;

/* ===== Simulation v2 ===== */
const {Engine, Render, Runner, Bodies, Body, Constraint, Events, World}=Matter;
function createDrum(canvas, count){
  const engine=Engine.create({gravity:{x:0,y:0}}); engine.timing.timeScale=0.95;
  const world=engine.world; const W=canvas.clientWidth,H=canvas.clientHeight; canvas.width=W; canvas.height=H;
  const render=Render.create({canvas,engine,options:{width:W,height:H,wireframes:false,background:"transparent",pixelRatio:Math.min(2,devicePixelRatio||1)}});
  const cx=W*0.48, cy=H*0.58, R=Math.min(W,H)*0.38;

  // Circular wall via dense segments with overlap
  const segs=96, thick=28, segLen=(Math.PI*2*R)/segs+2;
  const walls=[]; for(let i=0;i<segs;i++){const a=i/segs*Math.PI*2, x=cx+Math.cos(a)*R, y=cy+Math.sin(a)*R;
    walls.push(Bodies.rectangle(x,y,thick,segLen,{isStatic:true,angle:a+Math.PI/2,slop:0.1,render:{fillStyle:"rgba(10,25,38,.96)"}}));}
  World.add(world,walls);

  // Outer invisible bounds (just in case)
  World.add(world,[Bodies.rectangle(W/2,-80,W+400,160,{isStatic:true,render:{visible:false}}),Bodies.rectangle(W/2,H+80,W+400,160,{isStatic:true,render:{visible:false}}),Bodies.rectangle(-80,H/2,160,H+400,{isStatic:true,render:{visible:false}}),Bodies.rectangle(W+80,H/2,160,H+400,{isStatic:true,render:{visible:false}})]);

  // Gate + chute
  const gateAngle=-Math.PI*0.14+Math.PI/2;
  const pivot={x:cx+Math.cos(gateAngle)*(R-70),y:cy+Math.sin(gateAngle)*(R-70)};
  const flap=Bodies.rectangle(pivot.x,pivot.y+60,26,120,{chamfer:{radius:6},render:{fillStyle:"#136d68"},frictionAir:0.02}); Body.setAngle(flap,gateAngle);
  const hinge=Constraint.create({pointA:pivot,bodyB:flap,pointB:{x:0,y:-60},stiffness:1,length:0}); World.add(world,[flap,hinge]);
  const chute1=Bodies.rectangle(pivot.x+60,pivot.y-8,140,12,{isStatic:true,angle:-0.35,render:{fillStyle:"rgba(60,200,170,.18)"}});
  const chute2=Bodies.rectangle(pivot.x+120,pivot.y+34,160,12,{isStatic:true,angle:-0.35,render:{fillStyle:"rgba(60,200,170,.18)"}});
  World.add(world,[chute1,chute2]);

  // Three paddles with ease-in speed
  const blade=(len,ang)=>Bodies.rectangle(cx,cy,len,14,{density:0.004,frictionAir:0.035,angle:ang,render:{fillStyle:"#17c3b2"}});
  const arms=[blade(R*0.82,0),blade(R*0.82,Math.PI/3),blade(R*0.82,-Math.PI/3)];
  arms.forEach(a=>World.add(world,[a,Constraint.create({pointA:{x:cx,y:cy},bodyB:a,length:0,stiffness:1})]));

  // Poisson-disk spawn inside circle (no overlaps)
  function spawnPositions(n, rad){ const pts=[]; let tries=0; while(pts.length<n && tries<5000){tries++; const rr=R*0.6*Math.sqrt(Math.random()), ang=Math.random()*Math.PI*2; const x=cx+Math.cos(ang)*rr, y=cy+Math.sin(ang)*rr;
      if(pts.every(p=>((p.x-x)**2+(p.y-y)**2)>(rad*2.2)**2)) pts.push({x,y}); } return pts; }
  const rBall=Math.max(10,R*0.08); const pos=spawnPositions(count,rBall);
  const balls=pos.map((p,i)=>{const b=Bodies.circle(p.x,p.y,rBall,{restitution:0.84,friction:0.018,frictionAir:0.02,density:0.0016,slop:0.01,render:{fillStyle:"#13b3aa",strokeStyle:"rgba(255,255,255,.08)",lineWidth:1}}); b.labelNum=i+1; return b;});
  World.add(world,balls);

  // Clip mask (visual): draw only inside drum
  function clipMask(ctx){ ctx.save(); ctx.beginPath(); ctx.arc(cx,cy,R-2,0,Math.PI*2); ctx.clip(); }
  function unclip(ctx){ ctx.restore(); }

  // Velocity cap for stability
  Events.on(engine,"beforeUpdate",()=>{
    const t=engine.timing.timestamp/1000;
    const target=Math.min(2, 0.3+ t*0.15); // ease-in
    arms.forEach((a,i)=>Body.setAngularVelocity(a, i%2?target:-target));
    Body.setAngle(flap,gateAngle); Body.setAngularVelocity(flap,0);
    balls.forEach(b=>{ b.velocity.x=Math.max(-12,Math.min(12,b.velocity.x)); b.velocity.y=Math.max(-12,Math.min(12,b.velocity.y)); });
  });

  // Pretty overlays + clipping
  Events.on(render,"beforeRender",()=>{
    const ctx=render.context; clipMask(ctx);
    // bezel ring
    ctx.save(); const g=ctx.createRadialGradient(cx,cy,R*0.25,cx,cy,R); g.addColorStop(0,'rgba(255,255,255,.06)'); g.addColorStop(1,'rgba(0,0,0,.55)');
    ctx.beginPath(); ctx.arc(cx,cy,R+18,0,Math.PI*2); ctx.lineWidth=28; ctx.strokeStyle=g; ctx.stroke(); ctx.restore();
  });
  Events.on(render,"afterRender",()=>{
    const ctx=render.context;
    // numbers with outline
    ctx.save(); ctx.textAlign="center"; ctx.textBaseline="middle"; ctx.font="800 14px Inter,system-ui";
    for(const b of balls){
      if(b.position.x<0||b.position.y<0||b.position.x>W||b.position.y>H) continue;
      ctx.lineWidth=3; ctx.strokeStyle="rgba(0,0,0,.55)"; ctx.strokeText(String(b.labelNum).padStart(2,'0'), b.position.x, b.position.y);
      ctx.fillStyle=(b.render.fillStyle==="#f9d67a")?"#241a05":"#eafffb"; ctx.fillText(String(b.labelNum).padStart(2,'0'), b.position.x, b.position.y);
      if(b.render.fillStyle==="#f9d67a"){ const g=ctx.createRadialGradient(b.position.x,b.position.y,6,b.position.x,b.position.y,34);
        g.addColorStop(0,"rgba(255,220,120,.35)"); g.addColorStop(1,"rgba(255,220,120,0)"); ctx.fillStyle=g; ctx.beginPath(); ctx.arc(b.position.x,b.position.y,34,0,Math.PI*2); ctx.fill(); }
    }
    unclip(ctx);
  });

  const runner=Runner.create();
  function start(){ Render.run(render); Runner.run(runner,engine); }
  function stop(){ Render.stop(render); Runner.stop(runner); }
  async function openFlap(ms=520){ for(let t=0;t<12;t++){ Body.rotate(flap,0.09); await sleep(12);} await sleep(ms); for(let t=0;t<12;t++){ Body.rotate(flap,-0.09); await sleep(12);} Body.setAngle(flap,gateAngle); }
  function insideGate(b){ const gx=pivot.x+40, gy=pivot.y+10; return (b.position.x>gx-28 && b.position.x<gx+48 && b.position.y>gy-28 && b.position.y<gy+48); }
  function tryEject(){ for(const b of balls){ if(b.picked) continue; if(insideGate(b)){ Body.setVelocity(b,{x:10,y:-2}); Body.setAngularVelocity(b,3); b.picked=true; b.render.fillStyle="#f9d67a"; return b; } } return null; }
  async function drawOne(){ await openFlap(500); const t0=performance.now(); while(performance.now()-t0<1600){ const g=tryEject(); if(g) return g; await sleep(16);} return null; }

  return {start,stop,drawOne,getPicked:()=>balls.filter(b=>b.picked).map(b=>b.labelNum).sort((a,b)=>a-b)};
}
function sleep(ms){return new Promise(r=>setTimeout(r,ms));}

// Build drums
const drumA=createDrum(document.getElementById('canvasA'),50);
const drumB=createDrum(document.getElementById('canvasB'),12);
drumA.start(); drumB.start();

// Controls
document.getElementById('btnStop').onclick=()=>{drumA.stop();drumB.stop();};
document.getElementById('btnReset').onclick=()=>location.reload();
document.getElementById('btnStartDraw').onclick=async()=>{
  const btn=document.getElementById('btnStartDraw'); if(btn.disabled) return; btn.disabled=true;
  const res={main:[],euro:[],created_at:new Date().toISOString()};
  await sleep(900);
  for(let i=0;i<5;i++){ const b=await drumA.drawOne(); if(b) res.main.push(b.labelNum); document.getElementById('pickedList').innerHTML=`Gezogen: ${res.main.map(n=>`<span class='chip chip--gold ml-1'>${String(n).padStart(2,'0')}</span>`).join(' ')}`; await sleep(300); }
  for(let i=0;i<2;i++){ const b=await drumB.drawOne(); if(b) res.euro.push(b.labelNum); document.getElementById('pickedList').innerHTML=`Gezogen: ${res.main.map(n=>`<span class='chip chip--gold ml-1'>${String(n).padStart(2,'0')}</span>`).join(' ')} ¬∑ ${res.euro.map(n=>`<span class='chip chip--gold ml-1'>${String(n).padStart(2,'0')}</span>`).join(' ')}`; await sleep(300); }
  res.main.sort((a,b)=>a-b); res.euro.sort((a,b)=>a-b);
  document.getElementById('result').innerHTML=`<b>Ergebnis:</b> Haupt: ${res.main.map(n=>String(n).padStart(2,'0')).join(' ')} ¬∑ Euro: ${res.euro.map(n=>String(n).padStart(2,'0')).join(' ')}<div class="text-xs opacity-80">${res.created_at}</div>`;
  btn.disabled=false;
};
</script>
</body>
</html>
