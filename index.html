
<!doctype html>
<html lang='de'>
<head>
<meta charset='utf-8'>
<meta name='viewport' content='width=device-width, initial-scale=1'>
<title>Trommel â€“ Debug Build</title>
<style>
  body{margin:0;font-family:system-ui,Segoe UI,Roboto,Arial,sans-serif;background:#0b1220;color:#e8eef9}
  .wrap{max-width:980px;margin:24px auto;padding:0 12px}
  .glass{background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.12);border-radius:.9rem;padding:.9rem}
  .badge{display:inline-block;padding:.2rem .6rem;border-radius:.5rem;border:1px solid rgba(255,255,255,.15);font-size:.85rem;opacity:.9}
  .btn{padding:.55rem .9rem;border-radius:.6rem;border:1px solid rgba(255,255,255,.15);background:rgba(255,255,255,.06);color:#e8eef9;cursor:pointer}
  .btn--green{background:rgba(16,185,129,.2)}
  .btn--amber{background:rgba(245,158,11,.2)}
  .chip{display:inline-flex;align-items:center;justify-content:center;min-width:34px;height:34px;border-radius:999px;padding:0 .5rem;border:1px solid rgba(255,255,255,.2);margin:.15rem;background:rgba(255,255,255,.96);color:#111;font-weight:700}
  .debug{position:fixed;left:8px;bottom:8px;background:#111a;border:1px solid #fff3;border-radius:8px;padding:8px 10px;font:12px/1.35 monospace;max-width:92vw;z-index:9999;white-space:pre-wrap}
</style>
</head>
<body>
<div class='wrap'>
  <h2 style='margin:0 0 .5rem;font-size:1.4rem;font-weight:800'>ðŸŽ± Ziehung â€“ Trommel (Debug)</h2>
  <div class='badge' id='drumLabel'>Venus Â· 50 gelbe Styroporkugeln</div>
  <div class='glass' style='display:grid;grid-template-columns:1fr 330px;gap:12px;margin-top:.6rem'>
    <div>
      <canvas id='drumCanvas' width='680' height='520' style='width:100%;height:auto;background:#0b1022;border:1px solid rgba(255,255,255,.1);border-radius:.6rem'></canvas>
    </div>
    <div class='glass'>
      <div style='font-weight:700;margin-bottom:.35rem'>Bedienung</div>
      <div style='opacity:.85;font-size:.95rem'>Debug-Build mit Statusanzeige & Notfall-Buttons.</div>
      <div style='margin-top:.6rem;display:flex;gap:.5rem;flex-wrap:wrap'>
        <button class='btn btn--green' id='startBtn'>ðŸŽ¬ Start Auto-Ziehung</button>
        <button class='btn btn--amber' id='resetBtn'>ðŸ”„ Reset</button>
        <button class='btn' id='oneBallBtn'>ðŸŸ¡ 1 Testkugel anzeigen</button>
      </div>
      <div style='margin-top:.6rem'>
        <div class='badge'>Gezogene Hauptzahlen</div>
        <div id='outMain' style='margin-top:.25rem;display:flex;flex-wrap:wrap'></div>
        <div class='badge' style='margin-top:.6rem'>Gezogene Eurozahlen</div>
        <div id='outEuro' style='margin-top:.25rem;display:flex;flex-wrap:wrap'></div>
      </div>
      <div style='margin-top:.6rem;font:12px/1.35 monospace'>
        <div>Canvas: <span id='infoCanvas'></span></div>
        <div>Phase: <span id='infoPhase'>idle</span> | BÃ¤lle: <span id='infoBalls'>0</span> | fps: <span id='infoFps'>0</span></div>
      </div>
    </div>
  </div>
</div>

<div class='debug' id='debug'></div>

<script>
(function(){
  const dbg = document.getElementById('debug');
  function log(s){ dbg.textContent += s + "\n"; dbg.scrollTop = dbg.scrollHeight; }
  window.addEventListener('error', e=>{ log('JS ERROR: ' + e.message + '\n' + e.filename + ':' + e.lineno); });
  window.addEventListener('unhandledrejection', e=>{ log('PROMISE ERROR: ' + e.reason); });

  const canvas = document.getElementById('drumCanvas');
  const ctx = canvas.getContext('2d');
  const infoCanvas = document.getElementById('infoCanvas');
  infoCanvas.textContent = canvas.width + 'Ã—' + canvas.height + ' CSS:' + canvas.clientWidth + 'Ã—' + canvas.clientHeight;

  const infoPhase = document.getElementById('infoPhase');
  const infoBalls = document.getElementById('infoBalls');
  const infoFps = document.getElementById('infoFps');

  const startBtn = document.getElementById('startBtn');
  const resetBtn = document.getElementById('resetBtn');
  const oneBallBtn = document.getElementById('oneBallBtn');
  const outMain = document.getElementById('outMain');
  const outEuro = document.getElementById('outEuro');
  const label = document.getElementById('drumLabel');

  const R = 10;
  const W = canvas.width, H = canvas.height;
  const CX = W*0.5, CY = H*0.50, DRUM_R = Math.min(W,H)*0.44;

  const CATCH_POS = { x: CX + DRUM_R*0.50, y: CY - DRUM_R*0.78 };
  const CATCH_R = 18;

  const JETS = [
    {x: CX - DRUM_R*0.30, y: CY + DRUM_R*0.62, phase: 0},
    {x: CX,               y: CY + DRUM_R*0.62, phase: Math.PI/2},
    {x: CX + DRUM_R*0.30, y: CY + DRUM_R*0.62, phase: Math.PI}
  ];

  let balls=[], phase='idle', running=false, rafId=null, last=0;
  let drawnMain=[], drawnEuro=[];
  let tNoise=0, lastCatch=0, jetT=0;
  let lastFps=performance.now(), frames=0;

  function pill(n, euro=false){
    const span=document.createElement('span');
    span.className='chip'+(euro?' euro':'');
    span.textContent=n;
    return span;
  }
  function renderOutputs(){
    outMain.innerHTML=''; drawnMain.forEach(n=> outMain.appendChild(pill(n,false)));
    outEuro.innerHTML=''; drawnEuro.forEach(n=> outEuro.appendChild(pill(n,true)));
  }
  function rng(a,b){ return a + Math.random()*(b-a); }

  function initBalls(count, isPearl){
    balls.length=0;
    const labels=Array.from({length:count},(_,i)=> i+1);
    for(let i=0;i<count;i++){
      const a=Math.random()*Math.PI*2, r=DRUM_R*0.55*rng(0.35,0.92);
      const x=CX + r*Math.cos(a), y=CY + r*Math.sin(a);
      balls.push({ id:labels[i], x,y, vx:rng(-80,80), vy:rng(-80,80), r:R });
    }
    label.textContent = isPearl ? 'Pearl Â· 12 weiÃŸe Styroporkugeln' : 'Venus Â· 50 gelbe Styroporkugeln';
    infoBalls.textContent = balls.length;
  }

  function drawDrum(){
    ctx.clearRect(0,0,W,H);
    ctx.beginPath(); ctx.arc(CX,CY,DRUM_R,0,Math.PI*2);
    ctx.strokeStyle='rgba(180,220,255,0.35)'; ctx.lineWidth=8; ctx.stroke();
    ctx.beginPath(); ctx.arc(CATCH_POS.x, CATCH_POS.y, CATCH_R, 0, Math.PI*2);
    ctx.strokeStyle='rgba(255,255,255,.38)'; ctx.lineWidth=3; ctx.stroke();
    JETS.forEach(j=>{ ctx.beginPath(); ctx.arc(j.x, j.y, 6, 0, Math.PI*2); ctx.fillStyle='rgba(180,220,255,.35)'; ctx.fill(); });
  }
  function drawBall(b, isPearl){
    ctx.beginPath(); ctx.arc(b.x,b.y,b.r,0,Math.PI*2);
    ctx.fillStyle = isPearl ? 'rgba(255,255,255,0.96)' : 'rgba(255,240,120,0.98)';
    ctx.fill(); ctx.lineWidth=1.5; ctx.strokeStyle = 'rgba(0,0,0,0.45)'; ctx.stroke();
    ctx.fillStyle='#111'; ctx.font='bold 12px system-ui, sans-serif';
    const s=String(b.id); const w=ctx.measureText(s).width; ctx.fillText(s, b.x-w/2, b.y+4);
  }

  function step(dt, now, isPearl){
    jetT+=dt; tNoise+=dt;
    const baseLift = isPearl ? 170 : 210;
    const gvec = {x:0, y:65};
    if(tNoise>0.22){ tNoise=0; for(const b of balls){ b.vx+=rng(-28,28); b.vy+=rng(-28,28);} }
    for(const b of balls){
      b.vx*=0.988; b.vy*=0.988;
      b.vx+=gvec.x*dt; b.vy+=gvec.y*dt;
      for(const J of JETS){
        const px=b.x-J.x, py=b.y-J.y, d2=px*px+py*py;
        if(d2 < 72*72){
          const pulse=(Math.sin(jetT*2.5 + J.phase)+1)*0.5;
          b.vy -= baseLift*pulse*dt;
          b.vx += px*0.004*dt;
        }
      }
      b.x+=b.vx*dt; b.y+=b.vy*dt;
      const dx=b.x-CX, dy=b.y-CY, dist=Math.hypot(dx,dy), maxR=DRUM_R-b.r-4;
      if(dist>maxR){ const nx=dx/dist, ny=dy/dist; b.x=CX+nx*maxR; b.y=CY+ny*maxR;
        const vn=b.vx*nx + b.vy*ny; const vtx=b.vx - vn*nx, vty=b.vy - vn*ny; const e=0.80;
        b.vx = vtx*1.01 - e*vn*nx; b.vy = vty*1.01 - e*vn*ny; }
    }
    // simple catch
    for(let i=balls.length-1;i>=0;i--){
      const b=balls[i], d=Math.hypot(b.x-CATCH_POS.x, b.y-CATCH_POS.y);
      const wait = (phase==='main') ? 1500 : 1800;
      if(d < CATCH_R-2){
        if(now - lastCatch < wait){ continue; }
        balls.splice(i,1); lastCatch = now;
        if(phase==='main'){ drawnMain.push(b.id); } else { drawnEuro.push(b.id); }
        renderOutputs(); infoBalls.textContent = balls.length;
        if(phase==='main' && drawnMain.length===5){ setTimeout(()=>{ phase='euro'; initBalls(12,true); infoPhase.textContent='euro'; }, 600); }
        if(phase==='euro' && drawnEuro.length===2){ phase='done'; infoPhase.textContent='done'; running=false; }
      }
    }
  }

  function draw(){
    const isPearl=(phase==='euro'||phase==='done');
    drawDrum();
    for(const b of balls) drawBall(b, isPearl);
  }

  function loop(ts){
    if(!running) return;
    const now=performance.now(), t=ts*0.001, dt=Math.min(0.033, last? (t-last):0.016); last=t;
    step(dt, now, (phase!=='main'));
    draw();
    frames++;
    if(performance.now()-lastFps>500){ infoFps.textContent = Math.round(frames*1000/(performance.now()-lastFps)); frames=0; lastFps=performance.now(); }
    rafId=requestAnimationFrame(loop);
  }

  function start(){ running=true; last=0; lastCatch=performance.now(); infoPhase.textContent='main'; rafId=requestAnimationFrame(loop); }
  function reset(){ running=false; drawnMain.length=0; drawnEuro.length=0; outMain.innerHTML=''; outEuro.innerHTML=''; phase='idle'; balls.length=0; infoBalls.textContent='0'; infoPhase.textContent='idle'; draw(); }

  startBtn.addEventListener('click', ()=>{ reset(); initBalls(50,false); phase='main'; start(); });
  resetBtn.addEventListener('click', ()=>{ reset(); });
  oneBallBtn.addEventListener('click', ()=>{
    reset();
    balls=[{id:1,x:CX,y:CY,vx:0,vy:0,r:R}];
    infoBalls.textContent='1';
    draw();
    log('Eine Testkugel wurde gerendert. Wenn du sie nicht siehst, ist der Canvas verdeckt/unsichtbar.');
  });

  draw();
  log('Debug-Build geladen. Canvas: ' + canvas.width + 'x' + canvas.height + ' CSS:' + canvas.clientWidth + 'x' + canvas.clientHeight);
})();
</script>
</body>
</html>
