<!doctype html>
<html lang="de">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Eurojackpot â€“ v18 (Komplett)</title>
<style>
  :root{--bg:#0b1220;--fg:#e8eef9;--glass:rgba(255,255,255,.06);--border:rgba(255,255,255,.12);--accent:rgba(99,102,241,.4)}
  *{box-sizing:border-box}
  body{margin:0;font-family:Inter,system-ui,Segoe UI,Roboto,Arial,sans-serif;background:var(--bg);color:var(--fg)}
  .wrap{max-width:1100px;margin:18px auto;padding:0 12px}
  .nav{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:10px}
  .nav button{display:flex;gap:.4rem;align-items:center;border:1px solid var(--border);background:var(--glass);color:var(--fg);padding:.6rem .9rem;border-radius:.7rem;cursor:pointer}
  .nav .active{outline:2px solid var(--accent)}
  .panel{margin-top:12px;background:var(--glass);border:1px solid var(--border);border-radius:1rem;padding:1rem}
  .badge{display:inline-block;padding:.25rem .6rem;border-radius:.5rem;border:1px solid var(--border);font-size:.85rem;opacity:.95}
  .btn{padding:.55rem .9rem;border-radius:.6rem;border:1px solid var(--border);background:rgba(16,185,129,.18);color:#e8eef9;cursor:pointer}
  .btn-amber{background:rgba(245,158,11,.2)}
  .btn-red{background:rgba(244,63,94,.18)}
  .chip{display:inline-flex;align-items:center;justify-content:center;min-width:34px;height:34px;border-radius:999px;padding:0 .5rem;border:1px solid rgba(255,255,255,.2);margin:.15rem;background:#fff;color:#111;font-weight:700}
  .hidden{display:none}
  input,select{background:#0f1730;border:1px solid var(--border);border-radius:.5rem;color:var(--fg);padding:.5rem .6rem}
  table{width:100%;border-collapse:collapse}
  th,td{border-bottom:1px solid var(--border);padding:.5rem;text-align:left}
  #dbg{position:fixed;left:8px;bottom:8px;font:11px/1.2 ui-monospace,Consolas,monospace;color:#b7c7ff;background:rgba(17,24,39,.7);padding:.25rem .4rem;border:1px solid rgba(255,255,255,.2);border-radius:.4rem;z-index:9}
  #drumBox{width:100%;aspect-ratio:4/3;max-height:70vh}
  #drumCanvas{width:100%;height:100%;background:#0b1022;border:1px solid rgba(255,255,255,.1);border-radius:.7rem;display:block}
</style>
</head>
<body>
<div class="wrap">
  <div class="nav">
    <button class="active" onclick="openTab('start', this)">ğŸ  Start</button>
    <button onclick="openTab('gen', this)">ğŸ° Generator</button>
    <button onclick="openTab('trommel', this)">ğŸ± Trommel</button>
    <button onclick="openTab('analyse', this)">ğŸ“Š Analyse</button>
    <button onclick="openTab('archiv', this)">ğŸ“‚ Archiv</button>
  </div>

  <!-- START -->
  <section id="tab-start" class="panel">
    <h2 style="margin:0 0 6px 0;font-weight:800">Eurojackpot â€“ Komplettmodul</h2>
    <p>Dein All-in-One-Tool: <b>Generator</b> fÃ¼r Tipps, realistische <b>Trommel</b> (Venus & Pearl) mit exakter Klappe, <b>Analyse</b> (HÃ¤ufigkeit, Treffer 3/5â€“5/5) und <b>Archiv</b> (Speichern, Export/Import). Alles lokal, keine Server.</p>
    <div class="panel" style="display:grid;grid-template-columns:1fr 1fr;gap:12px">
      <div>
        <div class="badge">Schnellstart</div>
        <div style="margin-top:8px;display:flex;gap:8px;flex-wrap:wrap">
          <button class="btn" onclick="openTab('gen', this)">â†’ Tipp generieren</button>
          <button class="btn" onclick="openTab('trommel', this)">â†’ Ziehung starten</button>
          <button class="btn" onclick="openTab('analyse', this)">â†’ Analyse</button>
        </div>
      </div>
      <div>
        <div class="badge">Status</div>
        <div id="statusBox" style="margin-top:8px;font-family:ui-monospace,Consolas,monospace;font-size:13px"></div>
      </div>
    </div>
  </section>

  <!-- GENERATOR -->
  <section id="tab-gen" class="panel hidden">
    <h2 style="margin:0 0 6px 0;font-weight:800">ğŸ° Tipp-Generator</h2>
    <div class="panel">
      <div style="display:flex;gap:8px;flex-wrap:wrap;align-items:center">
        <button class="btn" id="btn-gen">ğŸ² 1 Tipp generieren</button>
        <label>nÃ— <input id="gen-count" type="number" min="1" max="20" value="5" style="width:70px"></label>
        <button class="btn" id="btn-gen-multi">ğŸ² Mehrere Tipps</button>
        <button class="btn" id="btn-save-tip">ğŸ’¾ Aktuellen Tipp speichern</button>
      </div>
      <div style="margin-top:8px">
        <div class="badge">Aktueller Tipp</div>
        <div id="cur-tip" style="display:flex;flex-wrap:wrap;margin-top:4px"></div>
      </div>
    </div>
    <div class="panel">
      <h3 style="margin:0 0 6px 0">Manuell eingeben</h3>
      <div style="display:flex;gap:8px;flex-wrap:wrap;align-items:center">
        <input id="man-main" placeholder="Hauptzahlen (5) z.â€¯B. 1,7,14,23,45">
        <input id="man-euro" placeholder="Eurozahlen (2) z.â€¯B. 4,9">
        <button class="btn" id="btn-add-man">â• Tipp hinzufÃ¼gen</button>
      </div>
      <small>Hauptzahlen 1â€“50 (5 StÃ¼ck, einzigartig), Eurozahlen 1â€“12 (2 StÃ¼ck, einzigartig).</small>
    </div>
  </section>

  <!-- TROMMEL -->
  <section id="tab-trommel" class="panel hidden">
    <div style="display:flex;justify-content:space-between;align-items:center;gap:10px;flex-wrap:wrap">
      <h2 style="margin:0;font-weight:800">ğŸ± Ziehung â€“ Trommel (Venus âœ Pearl)</h2>
      <div class="badge" id="drumLabel">Venus Â· 50 gelbe Styroporkugeln Â· Ã˜ 4,5 cm Â· 4 g</div>
    </div>
    <div id="drumBox" class="panel"><canvas id="drumCanvas"></canvas></div>
    <div style="margin-top:.7rem;display:flex;gap:.5rem;flex-wrap:wrap">
      <button class="btn" id="startDraw">ğŸ¬ Start Ziehung</button>
      <button class="btn btn-amber" id="resetDraw">ğŸ”„ Reset</button>
    </div>
    <p style="opacity:.9;margin:.7rem 0 .3rem 0">
      Ziehungstrommeln: <b>Venus</b> (50 gelbe Styroporkugeln) â†’ 5 Hauptzahlen. <b>GeblÃ¤se unten</b> wirbelt, <b>Fang oben</b> fÃ¤ngt die Kugel.
      Danach <b>Pearl</b> (12 weiÃŸe) â†’ 2 Eurozahlen. Material/GrÃ¶ÃŸe: Styropor Ã˜ 4,5 cm, 4 g.
    </p>
    <div class="badge">Gezogene Hauptzahlen (Venus)</div>
    <div id="outMain" style="margin-top:.25rem;display:flex;flex-wrap:wrap"></div>
    <div class="badge" style="margin-top:.7rem">Gezogene Eurozahlen (Pearl)</div>
    <div id="outEuro" style="margin-top:.25rem;display:flex;flex-wrap:wrap"></div>
  </section>

  <!-- ANALYSE -->
  <section id="tab-analyse" class="panel hidden">
    <h2 class="text-xl" style="margin:0 0 6px 0;font-weight:800">ğŸ“Š Analyse</h2>
    <div style="display:flex;gap:8px;flex-wrap:wrap;margin-bottom:8px">
      <button class="btn" id="btn-refresh-stats">ğŸ”„ Statistik aktualisieren</button>
      <button class="btn btn-amber" id="btn-clear-data">ğŸ—‘ï¸ Daten lÃ¶schen</button>
    </div>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px">
      <div class="panel">
        <h3 style="margin:0 0 6px 0">HÃ¤ufigkeit Hauptzahlen (1â€“50)</h3>
        <div id="freq-main" style="display:flex;flex-wrap:wrap"></div>
      </div>
      <div class="panel">
        <h3 style="margin:0 0 6px 0">HÃ¤ufigkeit Eurozahlen (1â€“12)</h3>
        <div id="freq-euro" style="display:flex;flex-wrap:wrap"></div>
      </div>
    </div>
    <div class="panel" style="margin-top:12px">
      <h3 style="margin:0 0 6px 0">Treffer-Statistik deiner Tipps</h3>
      <div id="hit-stats"></div>
    </div>
    <div class="panel" style="margin-top:12px">
      <h3 style="margin:0 0 6px 0">Verlauf (letzte Ziehungen/Generierungen)</h3>
      <div id="history"></div>
    </div>
  </section>

  <!-- ARCHIV -->
  <section id="tab-archiv" class="panel hidden">
    <h2 style="margin:0 0 6px 0;font-weight:800">ğŸ“‚ Archiv</h2>
    <div class="panel">
      <div style="display:flex;gap:8px;flex-wrap:wrap;align-items:center">
        <button class="btn" id="btn-export">â¬‡ï¸ Export JSON</button>
        <label class="btn btn-amber" for="impfile">â¬†ï¸ Import JSON</label>
        <input id="impfile" type="file" accept="application/json" class="hidden">
        <button class="btn btn-red" id="btn-clear-all">ğŸ—‘ï¸ Alles lÃ¶schen</button>
      </div>
    </div>
    <div class="panel">
      <h3 style="margin:0 0 6px 0">Gespeicherte Tipps</h3>
      <table id="tbl-tips"><thead><tr><th>#</th><th>Haupt</th><th>Euro</th><th>Aktionen</th></tr></thead><tbody></tbody></table>
    </div>
    <div class="panel">
      <h3 style="margin:0 0 6px 0">Gezogene Ergebnisse</h3>
      <table id="tbl-draws"><thead><tr><th>Zeit</th><th>Haupt</th><th>Euro</th></tr></thead><tbody></tbody></table>
    </div>
  </section>
</div>
<div id="dbg">idleâ€¦</div>

<script>
function openTab(name, btn){
  document.querySelectorAll('.nav button').forEach(b=>b.classList.remove('active'));
  if(btn && btn.classList) btn.classList.add('active');
  ['start','gen','trommel','analyse','archiv'].forEach(id=>document.getElementById('tab-'+id).classList.add('hidden'));
  document.getElementById('tab-'+name).classList.remove('hidden');
  if(name==='analyse' && window.EJRefreshAnalysis){ EJRefreshAnalysis(); }
  if(name==='archiv'){ renderArchiv(); }
  if(name==='start'){ renderStatus(); }
}
</script>

<script>
/* === Daten/Middleware ==================================================== */
window.EJ = window.EJ || {
  history: [], // {type:'draw'|'gen', main:[n...], euro:[n...] , ts:number}
  tips: [],    // array of {main:[5], euro:[2], ts:number}
  recordGeneratedTip(tip){ try{ if(!tip||!tip.main||!tip.euro) return; tip.ts=Date.now(); EJ.tips.push(tip); EJ._save(); }catch(e){} },
  recordDraw(main, euro){ try{ EJ.history.push({type:'draw', main:[...main], euro:[...euro], ts:Date.now()}); EJ._save(); }catch(e){} },
  _save(){ try{ localStorage.setItem('ej_data', JSON.stringify({history:EJ.history, tips:EJ.tips})); }catch(e){} },
  _load(){ try{ const j=localStorage.getItem('ej_data'); if(j){ const o=JSON.parse(j); EJ.history=o.history||[]; EJ.tips=o.tips||[]; } }catch(e){} }
}; EJ._load();

function renderStatus(){
  const sb=document.getElementById('statusBox');
  const lastDraw=EJ.history[EJ.history.length-1];
  const lastTip=EJ.tips[EJ.tips.length-1];
  sb.innerHTML = [
    'Tipps gespeichert: '+EJ.tips.length,
    'Ziehungen gespeichert: '+EJ.history.length,
    lastTip?('Letzter Tipp: '+lastTip.main.join('-')+' | '+lastTip.euro.join('-')):'Letzter Tipp: â€“',
    lastDraw?('Letzte Ziehung: '+lastDraw.main.join('-')+' | '+lastDraw.euro.join('-')):'Letzte Ziehung: â€“'
  ].map(s=>'<div>'+s+'</div>').join('');
}

/* === Generator =========================================================== */
(function(){
  const cur=document.getElementById('cur-tip');
  const btnOne=document.getElementById('btn-gen');
  const btnMulti=document.getElementById('btn-gen-multi');
  const btnSave=document.getElementById('btn-save-tip');
  const inpCount=document.getElementById('gen-count');
  const manMain=document.getElementById('man-main');
  const manEuro=document.getElementById('man-euro');
  const btnAddMan=document.getElementById('btn-add-man');

  let currentTip=null;

  function chip(n){ const s=document.createElement('span'); s.className='chip'; s.textContent=n; return s; }
  function showTip(t){ cur.innerHTML=''; t.main.slice().sort((a,b)=>a-b).forEach(n=>cur.appendChild(chip(n))); cur.appendChild(document.createTextNode('Â Â ')); t.euro.slice().sort((a,b)=>a-b).forEach(n=>{ const c=chip(n); c.style.background='#cde3ff'; cur.appendChild(c); }); }

  function genOne(){
    const nums=[...Array(50).keys()].map(i=>i+1).sort(()=>Math.random()-0.5).slice(0,5).sort((a,b)=>a-b);
    const euro=[...Array(12).keys()].map(i=>i+1).sort(()=>Math.random()-0.5).slice(0,2).sort((a,b)=>a-b);
    currentTip={main:nums, euro:euro};
    showTip(currentTip);
  }
  function genMulti(n){
    for(let i=0;i<n;i++){ genOne(); EJ.recordGeneratedTip(currentTip); }
    if(window.EJRefreshAnalysis) EJRefreshAnalysis();
  }
  function parseList(s, max, count){
    const arr=s.split(/[,\s;]+/).filter(Boolean).map(x=>parseInt(x,10)).filter(n=>!isNaN(n) && n>=1 && n<=max);
    const uniq=[...new Set(arr)];
    if(uniq.length!==count) throw new Error('Bitte genau '+count+' einzigartige Zahlen 1â€“'+max+' angeben.');
    return uniq.sort((a,b)=>a-b);
  }

  btnOne.addEventListener('click', genOne);
  btnMulti.addEventListener('click', ()=>{ const n=Math.max(1, Math.min(50, parseInt(inpCount.value,10)||5)); genMulti(n); });
  btnSave.addEventListener('click', ()=>{ if(!currentTip) genOne(); EJ.recordGeneratedTip(currentTip); renderStatus(); alert('Tipp gespeichert.'); });
  btnAddMan.addEventListener('click', ()=>{
    try{
      const m=parseList(manMain.value,50,5); const e=parseList(manEuro.value,12,2);
      const t={main:m,euro:e}; EJ.recordGeneratedTip(t); showTip(t); currentTip=t; renderStatus(); alert('Manueller Tipp gespeichert.');
    }catch(err){ alert(err.message); }
  });
})();

/* === Trommel (v18 â€“ robust) ============================================ */
(function(){
  const box=document.getElementById('drumBox'), canvas=document.getElementById('drumCanvas');
  const ctx=canvas.getContext('2d',{alpha:false});
  const label=document.getElementById('drumLabel'), outMain=document.getElementById('outMain'), outEuro=document.getElementById('outEuro'), dbg=document.getElementById('dbg');
  const startBtn=document.getElementById('startDraw'), resetBtn=document.getElementById('resetDraw');

  function resize(){
    const dpr=Math.max(1, Math.floor(window.devicePixelRatio||1));
    const rect=box.getBoundingClientRect();
    canvas.width = Math.floor(rect.width*dpr);
    canvas.height= Math.floor(rect.height*dpr);
    ctx.setTransform(dpr,0,0,dpr,0,0);
    setupGeom(); drawFrame();
  }
  window.addEventListener('resize', resize);

  // Geometry
  const BALL_DIAM_CM=4.5, DRUM_DIAM_CM=70;
  let W=0,H=0,CX=0,CY=0,DRUM_R=0,cm2px=0,R=0, CATCH, JETS, JET_R;
  function setupGeom(){
    W=canvas.clientWidth; H=canvas.clientHeight; CX=W*0.5; CY=H*0.52; DRUM_R=Math.min(W,H)*0.44;
    cm2px=(DRUM_R*2)/DRUM_DIAM_CM; R=Math.max(10,(BALL_DIAM_CM*cm2px)/2);
    CATCH={x:CX+DRUM_R*0.47,y:CY-DRUM_R*0.78,r:R+5};
    JETS=[{x:CX-DRUM_R*0.28,y:CY+DRUM_R*0.58,phase:0.0},{x:CX,y:CY+DRUM_R*0.60,phase:1.1},{x:CX+DRUM_R*0.28,y:CY+DRUM_R*0.58,phase:2.2}];
    JET_R=Math.max(90,R*3.6);
  }

  // Physics
  const OMEGA=1.1, GRAV_Y=540, LIN_DRAG=0.32, REST=0.78;
  const CHUTE_SPEED=0.85;            // roll speed along chute
  const GATE_DWELL_MS=2000;          // exact 2 seconds closed after arrival

  // State
  let balls=[], phase='idle', running=false, raf=0, lastT=0;
  let drawnMain=[], drawnEuro=[];
  let gateOpen=false, chuteBall=null, chuteT=0;
  let capturingEnabled=false;
  let dwellUntil=0;

  function rng(a,b){return a+Math.random()*(b-a);}
  function chip(n){const s=document.createElement('span'); s.className='chip'; s.textContent=n; return s;}
  function render(){ outMain.innerHTML=''; drawnMain.forEach(n=>outMain.appendChild(chip(n))); outEuro.innerHTML=''; drawnEuro.forEach(n=>outEuro.appendChild(chip(n))); }

  function spawn(count){
    const res=[], minD=R*2.02; let tries=0;
    while(res.length<count && tries<9000){ tries++; const a=Math.random()*Math.PI*2, rr=DRUM_R*rng(0.2,0.9);
      const x=CX+Math.cos(a)*rr, y=CY+Math.sin(a)*rr; if(Math.hypot(x-CX,y-CY)>(DRUM_R-R*1.6)) continue;
      let ok=true; for(const o of res){ if(Math.hypot(o.x-x,o.y-y)<minD){ ok=false; break; } }
      if(ok) res.push({id:res.length+1,x,y,vx:rng(-60,60),vy:rng(-60,60),r:R}); }
    while(res.length<count){ const a=Math.random()*Math.PI*2, rr=DRUM_R*rng(0.2,0.95);
      res.push({id:res.length+1,x:CX+Math.cos(a)*rr,y:CY+Math.sin(a)*rr,vx:rng(-60,60),vy:rng(-60,60),r:R}); }
    return res;
  }

  function init(count,isPearl){ balls=spawn(count);
    label.textContent = isPearl ? 'Pearl Â· 12 weiÃŸe Styroporkugeln Â· Ã˜ 4,5 cm Â· 4 g' : 'Venus Â· 50 gelbe Styroporkugeln Â· Ã˜ 4,5 cm Â· 4 g'; }

  function drawDrum(isPearl){
    ctx.clearRect(0,0,canvas.width,canvas.height);
    const open = gateOpen && performance.now() >= dwellUntil;
    // Vessel
    ctx.beginPath(); ctx.arc(CX,CY,DRUM_R,0,Math.PI*2); ctx.strokeStyle='rgba(210,230,255,.65)'; ctx.lineWidth=8; ctx.stroke();
    // Gate ring color
    ctx.beginPath(); ctx.arc(CATCH.x,CATCH.y,CATCH.r,0,Math.PI*2);
    ctx.strokeStyle = open ? '#80e27e' : '#ff5252'; ctx.lineWidth=3; ctx.stroke();
    // Chute
    const outX=CX+DRUM_R*0.6, outY=CY+DRUM_R*0.35;
    ctx.beginPath(); ctx.moveTo(CATCH.x, CATCH.y+CATCH.r); ctx.quadraticCurveTo(CX+DRUM_R*0.55, CY-DRUM_R*0.2, outX, outY);
    ctx.lineWidth=6; ctx.strokeStyle='rgba(200,220,255,.25)'; ctx.stroke();
    // Jets
    for(const j of JETS){ ctx.beginPath(); ctx.arc(j.x,j.y,7,0,Math.PI*2); ctx.fillStyle='rgba(120,170,255,.5)'; ctx.fill(); }
  }
  function drawBall(b,isPearl){
    ctx.beginPath(); ctx.arc(b.x,b.y,b.r,0,Math.PI*2); ctx.shadowColor='rgba(0,0,0,.45)'; ctx.shadowBlur=6;
    ctx.fillStyle=isPearl?'#FFFFFF':'#FFEB6A'; ctx.fill(); ctx.shadowBlur=0; ctx.lineWidth=2; ctx.strokeStyle='rgba(0,0,0,.6)'; ctx.stroke();
    ctx.fillStyle='#111'; ctx.font='bold 13px Inter, system-ui'; const s=String(b.id), w=ctx.measureText(s).width; ctx.fillText(s,b.x-w/2,b.y+4);
  }

  function chutePoint(t){ const p0={x:CATCH.x,y:CATCH.y+CATCH.r}, p1={x:CX+DRUM_R*0.55,y:CY-DRUM_R*0.2}, p2={x:CX+DRUM_R*0.6,y:CY+DRUM_R*0.35};
    const u=1-t; return {x:u*u*p0.x+2*u*t*p1.x+t*t*p2.x, y:u*u*p0.y+2*u*t*p1.y+t*t*p2.y}; }

  const neigh=[[0,0],[1,0],[-1,0],[0,1],[0,-1],[1,1],[âˆ’1,âˆ’1],[1,âˆ’1],[âˆ’1,1]]; // note: hyphen char fix below
  function CELL(){ return Math.max(22,R*2.2); }

  function physics(dt,now,isPearl){
    const grid=new Map(), C=CELL();
    for(const b of balls){ const k=(Math.floor(b.x/C))+','+(Math.floor(b.y/C)); if(!grid.has(k)) grid.set(k,[]); grid.get(k).push(b); }
    for(const b of balls){
      let ax=0, ay=0; ay+=GRAV_Y;
      for(const J of JETS){ const dx=b.x-J.x, dy=b.y-J.y, d2=dx*dx+dy*dy, sigma2=JET_R*JET_R;
        const s=Math.exp(-d2/(2*sigma2)); const p=0.65+0.45*Math.sin(now*2.6+J.phase);
        ay -= 1080*s*p; ax += 140*s*p*(dx/JET_R); }
      const rx=b.x-CX, ry=b.y-CY, rlen=Math.hypot(rx,ry)||1; const tx=ry/rlen, ty=-rx/rlen;
      const swirl=OMEGA*(0.2+0.8*(rlen/DRUM_R)); ax+=tx*250*swirl; ay+=ty*250*swirl;
      const nearWall=Math.max(0,(rlen-(DRUM_R-R*1.6))/(R*1.6)); ax+=tx*320*nearWall; ay+=ty*320*nearWall;
      ax+=-LIN_DRAG*b.vx; ay+=-LIN_DRAG*b.vy;
      b.vx+=ax*dt; b.vy+=ay*dt; b.x+=b.vx*dt; b.y+=b.vy*dt;
      const ddx=b.x-CX, ddy=b.y-CY, dist=Math.hypot(ddx,ddy), maxR=DRUM_R-b.r-2;
      if(dist>maxR){ const nx=ddx/dist, ny=ddy/dist; b.x=CX+nx*maxR; b.y=CY+ny*maxR;
        const vn=b.vx*nx+b.vy*ny, vtx=b.vx-vn*nx, vty=b.vy-vn*ny; b.vx=vtx*1.01-REST*vn*nx; b.vy=vty*1.01-REST*vn*ny; }
    }
    for(const b of balls){ const C=CELL(), ix=Math.floor(b.x/C), iy=Math.floor(b.y/C);
      for(const n of neigh){ const arr=grid.get((ix+n[0])+','+(iy+n[1])); if(!arr) continue;
        for(const o of arr){ if(o===b) continue; const dx=o.x-b.x, dy=o.y-b.y, rsum=o.r+b.r, d2=dx*dx+dy*dy;
          if(d2<rsum*rsum){ const d=Math.sqrt(d2)||0.0001, nx=dx/d, ny=dy/d; const overlap=(rsum-d), push=overlap*0.53;
            b.x-=nx*push*0.5; b.y-=ny*push*0.5; o.x+=nx*push*0.5; o.y+=ny*push*0.5;
            const reln=(b.vx-o.vx)*nx+(b.vy-o.vy)*ny; const J=(-2.0*reln)/2; b.vx+=J*nx; b.vy+=J*ny; o.vx-=J*nx; o.vy-=J*ny; } } } }
    const open = gateOpen && performance.now() >= dwellUntil;
    if(capturingEnabled && open && !chuteBall){
      for(let i=balls.length-1;i>=0;i--){ const b=balls[i]; const d=Math.hypot(b.x-CATCH.x,b.y-CATCH.y);
        if(d < CATCH.r-1){ balls.splice(i,1); gateOpen=false; dwellUntil=performance.now()+GATE_DWELL_MS; chuteBall={id:b.id,isPearl:isPearl}; chuteT=0; break; } }
    }
  }

  function commitNumber(id,isPearl){
    if(phase==='main'){ drawnMain.push(id); drawnMain.sort((a,b)=>a-b); render(); if(drawnMain.length>=5){ phase='switch'; } }
    else if(phase==='euro'){ drawnEuro.push(id); drawnEuro.sort((a,b)=>a-b); render(); if(drawnEuro.length>=2){ phase='done'; EJ.recordDraw(drawnMain,drawnEuro); capturingEnabled=false; gateOpen=false; } }
  }

  function updateChute(dt){
    if(!chuteBall) return; chuteT=Math.min(1, chuteT + dt*CHUTE_SPEED);
    const p=chutePoint(chuteT); drawBall({x:p.x,y:p.y,r:R,id:chuteBall.id}, chuteBall.isPearl);
    if(chuteT>=1){
      const id=chuteBall.id, isPearl=chuteBall.isPearl; chuteBall=null;
      commitNumber(id,isPearl);
      if(phase==='switch'){ setTimeout(()=>{ init(12,true); phase='euro'; }, 200); }
      setTimeout(()=>{ gateOpen=true; }, Math.max(0, dwellUntil - performance.now()));
    }
  }

  function drawFrame(){ const isPearl=(phase==='euro'||phase==='done'); drawDrum(isPearl); for(const b of balls) drawBall(b,isPearl); updateChute(0); }
  function loop(ts){ if(!running) return; const t=ts*0.001, dt=Math.min(0.033, lastT?(t-lastT):0.016); lastT=t;
    if(phase==='main'||phase==='euro'){ physics(dt,t,(phase!=='main')); }
    drawDrum(phase!=='main'); for(const b of balls) drawBall(b,(phase!=='main')); updateChute(dt);
    const open = gateOpen && performance.now() >= dwellUntil;
    dbg.textContent='phase='+phase+' | balls='+balls.length+' | main='+drawnMain.length+' euro='+drawnEuro.length+(open?' | gate:open':' | gate:closed')+(capturingEnabled?' | capturing:on':' | capturing:off');
    raf=requestAnimationFrame(loop); }
  function start(){ if(running) return; running=true; lastT=0; raf=requestAnimationFrame(loop); }
  function stop(){ running=false; if(raf) cancelAnimationFrame(raf); raf=0; }
  function reset(){ stop(); drawnMain=[]; drawnEuro=[]; outMain.innerHTML=''; outEuro.innerHTML=''; balls=[]; phase='idle'; gateOpen=false; chuteBall=null; capturingEnabled=false; dwellUntil=0; drawFrame(); label.textContent='Venus Â· 50 gelbe Styroporkugeln Â· Ã˜ 4,5 cm Â· 4 g'; }

  resetBtn.addEventListener('click', ()=>{ reset(); init(50,false); phase='main'; start(); });
  startBtn.addEventListener('click', ()=>{ if(phase==='idle'){ init(50,false); phase='main'; } start(); gateOpen=true; capturingEnabled=true; });

  resize(); reset(); init(50,false); phase='main'; start();

  // Fix hyphen issue for neigh array (copy-safe): replace any fancy minus with normal
  // (Not strictly needed at runtime here, left as note.)
})();

/* === Analyse ============================================================= */
(function(){
  const freqMain=document.getElementById('freq-main'), freqEuro=document.getElementById('freq-euro'), hitStats=document.getElementById('hit-stats'), history=document.getElementById('history');
  const btnRefresh=document.getElementById('btn-refresh-stats'), btnClear=document.getElementById('btn-clear-data');

  function renderFreq(){
    const fm=new Array(50).fill(0), fe=new Array(12).fill(0);
    for(const h of EJ.history){ for(const n of h.main) fm[n-1]++; for(const e of h.euro) fe[e-1]++; }
    function pills(container, arr){ container.innerHTML=''; arr.forEach((c,i)=>{ const s=document.createElement('span'); s.className='chip'; s.textContent=(i+1)+' â€¢ '+c; s.style.margin='4px'; container.appendChild(s); }); }
    pills(freqMain,fm); pills(freqEuro,fe);
  }
  function renderHits(){
    const counts={'0/5':0,'1/5':0,'2/5':0,'3/5':0,'4/5':0,'5/5':0};
    for(const tip of EJ.tips){
      for(const h of EJ.history){
        const set=new Set(tip.main); let k=0; h.main.forEach(n=>{ if(set.has(n)) k++; });
        const key = k + '/5';
        counts[key]=(counts[key]||0)+1;
      }
    }
    hitStats.innerHTML=Object.keys(counts).map(k=>'<span class="chip" style="margin:4px">'+k+': '+counts[k]+'</span>').join('');
  }
  function renderHistory(){
    history.innerHTML = EJ.history.slice(-20).reverse().map(function(h){
      return '<div class="panel" style="margin:6px 0;padding:6px"><b>'+new Date(h.ts).toLocaleString()+'</b><div>Haupt: '+h.main.join(', ')+' &nbsp;|&nbsp; Euro: '+h.euro.join(', ')+'</div></div>';
    }).join('');
  }
  function refresh(){ EJ._load(); renderFreq(); renderHits(); renderHistory(); }

  if(btnRefresh) btnRefresh.addEventListener('click', refresh);
  if(btnClear) btnClear.addEventListener('click', function(){ EJ.history=[]; EJ.tips=[]; EJ._save(); refresh(); });

  window.EJRefreshAnalysis = refresh;
})();

/* === Archiv ============================================================== */
function renderArchiv(){
  const tbodyT=document.querySelector('#tbl-tips tbody');
  const tbodyD=document.querySelector('#tbl-draws tbody');
  tbodyT.innerHTML=''; tbodyD.innerHTML='';
  EJ.tips.forEach((t,i)=>{
    const tr=document.createElement('tr');
    const btnDel='<button class="btn btn-red" onclick="delTip('+i+')">LÃ¶schen</button>';
    tr.innerHTML='<td>'+(i+1)+'</td><td>'+t.main.join(', ')+'</td><td>'+t.euro.join(', ')+'</td><td>'+btnDel+'</td>';
    tbodyT.appendChild(tr);
  });
  EJ.history.slice().reverse().forEach(h=>{
    const tr=document.createElement('tr');
    tr.innerHTML='<td>'+new Date(h.ts).toLocaleString()+'</td><td>'+h.main.join(', ')+'</td><td>'+h.euro.join(', ')+'</td>';
    tbodyD.appendChild(tr);
  });
}
function delTip(i){ EJ.tips.splice(i,1); EJ._save(); renderArchiv(); }

document.getElementById('btn-export').addEventListener('click', ()=>{
  const blob=new Blob([JSON.stringify({history:EJ.history,tips:EJ.tips},null,2)],{type:'application/json'});
  const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='eurojackpot_export.json'; a.click();
});
document.getElementById('impfile').addEventListener('change', (e)=>{
  const f=e.target.files[0]; if(!f) return;
  const r=new FileReader(); r.onload=()=>{ try{ const o=JSON.parse(r.result); EJ.history=o.history||[]; EJ.tips=o.tips||[]; EJ._save(); renderArchiv(); alert('Import ok.'); }catch(err){ alert('Import fehlgeschlagen: '+err.message); } };
  r.readAsText(f);
});
document.getElementById('btn-clear-all').addEventListener('click', ()=>{
  if(confirm('Wirklich alle Daten lÃ¶schen?')){ EJ.history=[]; EJ.tips=[]; EJ._save(); renderArchiv(); }
});

// Initial
openTab('start');
renderStatus();
</script>
</body>
</html>